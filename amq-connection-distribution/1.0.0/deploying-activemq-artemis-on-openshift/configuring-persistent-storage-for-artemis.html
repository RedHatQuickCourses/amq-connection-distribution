<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Configuring persistent storage for Artemis :: Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</title>
    <link rel="prev" href="custom-resource-definitions-crds-for-artemis.html">
    <link rel="next" href="scaling-artemis-brokers-on-openshift.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="amq-connection-distribution" data-version="1.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="deploying-activemq-artemis-on-openshift.html">Deploying ActiveMQ Artemis on OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction-to-openshift-for-messaging-applications.html">Introduction to OpenShift for messaging applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="understanding-activemq-artemis-on-openshift.html">Understanding ActiveMQ Artemis on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="using-the-activemq-artemis-operator.html">Using the ActiveMQ Artemis Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="custom-resource-definitions-crds-for-artemis.html">Custom Resource Definitions (CRDs) for Artemis</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="configuring-persistent-storage-for-artemis.html">Configuring persistent storage for Artemis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scaling-artemis-brokers-on-openshift.html">Scaling Artemis brokers on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring-artemis-instances-on-openshift.html">Monitoring Artemis instances on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hands-on-lab-deploying-a-highly-available-activemq-artemis-cluster-on-openshift.html">Hands-on Lab: Deploying a highly available ActiveMQ Artemis cluster on OpenShift</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../message-distribution-issues/message-distribution-issues.html">Message distribution issues</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/understanding-distributed-messaging-patterns.html">Understanding distributed messaging patterns</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/load-balancing-messages-across-consumers.html">Load balancing messages across consumers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/message-routing-strategies-and-challenges.html">Message routing strategies and challenges</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/consumer-groups-and-shared-subscriptions.html">Consumer groups and shared subscriptions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/ensuring-message-ordering-in-distributed-systems.html">Ensuring message ordering in distributed systems</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/handling-message-durability-and-reliability.html">Handling message durability and reliability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/addressing-fault-tolerance-and-high-availability-for-messages.html">Addressing fault tolerance and high availability for messages</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../client-side-solution/client-side-solution.html">Client Side Solution</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/client-side-connection-management-and-pooling.html">Client-side connection management and pooling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/implementing-client-failover-mechanisms.html">Implementing client failover mechanisms</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/client-side-load-balancing-for-message-consumption.html">Client-side load balancing for message consumption</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/message-acknowledgment-patterns-auto_acknowledge-client_acknowledge.html">Message acknowledgment patterns (AUTO_ACKNOWLEDGE, CLIENT_ACKNOWLEDGE)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/transaction-management-for-message-producers-and-consumers.html">Transaction management for message producers and consumers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/best-practices-for-client-integration-with-distributed-brokers.html">Best practices for client integration with distributed brokers</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../quarkus-example/quarkus-example.html">Quarkus Example</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-example/integrating-jmsamqp-clients-with-quarkus.html">Integrating JMS/AMQP clients with Quarkus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-example/configuring-quarkus-for-activemq-artemis-connectivity.html">Configuring Quarkus for ActiveMQ Artemis connectivity</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-example/implementing-message-producers-in-quarkus.html">Implementing message producers in Quarkus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-example/implementing-message-consumers-in-quarkus.html">Implementing message consumers in Quarkus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-example/reactive-messaging-with-quarkus-and-artemis.html">Reactive messaging with Quarkus and Artemis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-example/deploying-quarkus-messaging-applications-on-openshift.html">Deploying Quarkus messaging applications on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-example/hands-on-lab-developing-a-quarkus-microservice-with-distributed-messaging.html">Hands-on Lab: Developing a Quarkus microservice with distributed messaging</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../spring-boot-example/spring-boot-example.html">Spring Boot Example</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/integrating-jmsamqp-clients-with-spring-boot.html">Integrating JMS/AMQP clients with Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/configuring-spring-boot-for-activemq-artemis-connectivity.html">Configuring Spring Boot for ActiveMQ Artemis connectivity</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/using-spring-jmsamqp-templates-for-messaging.html">Using Spring JMS/AMQP templates for messaging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/implementing-message-producers-in-spring-boot.html">Implementing message producers in Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/implementing-message-consumers-in-spring-boot.html">Implementing message consumers in Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/configuring-listener-containers-and-concurrency.html">Configuring listener containers and concurrency</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/deploying-spring-boot-messaging-applications-on-openshift.html">Deploying Spring Boot messaging applications on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/hands-on-lab-developing-a-spring-boot-microservice-with-distributed-messaging.html">Hands-on Lab: Developing a Spring Boot microservice with distributed messaging</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</a></li>
    <li><a href="deploying-activemq-artemis-on-openshift.html">Deploying ActiveMQ Artemis on OpenShift</a></li>
    <li><a href="configuring-persistent-storage-for-artemis.html">Configuring persistent storage for Artemis</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Configuring persistent storage for Artemis</h1>
<h1 id="_configuring_persistent_storage_for_activemq_artemis_on_openshift" class="sect0"><a class="anchor" href="#_configuring_persistent_storage_for_activemq_artemis_on_openshift"></a>Configuring Persistent Storage for ActiveMQ Artemis on OpenShift</h1>
<div class="paragraph">
<p>Ensuring message durability and broker state persistence is critical for any production-grade messaging system. On OpenShift, ActiveMQ Artemis leverages Kubernetes' persistent storage mechanisms to achieve this reliability. This section delves into the technical aspects of configuring persistent storage for your ActiveMQ Artemis brokers, including hands-on steps.</p>
</div>
<div class="sect1">
<h2 id="_detailed_technical_explanation"><a class="anchor" href="#_detailed_technical_explanation"></a>Detailed Technical Explanation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ActiveMQ Artemis is designed to handle high-throughput messaging, and a core component of its reliability is its ability to persist messages and state. When running Artemis in a containerized environment like OpenShift, ephemeral storage is the default. This means any data written to the container&#8217;s filesystem is lost when the container restarts, crashes, or is rescheduled. For a messaging broker, this would lead to message loss and an inconsistent state, which is unacceptable for most applications.</p>
</div>
<div class="paragraph">
<p>To overcome this, ActiveMQ Artemis on OpenShift utilizes Kubernetes' <code>PersistentVolume</code> (PV) and <code>PersistentVolumeClaim</code> (PVC) resources.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>PersistentVolume (PV)</strong>: A piece of storage in the cluster that has been provisioned by an administrator or dynamically provisioned using a <code>StorageClass</code>. It abstracts the underlying storage infrastructure (e.g., NFS, iSCSI, AWS EBS, OpenShift Container Storage/Ceph RBD).</p>
</li>
<li>
<p><strong>PersistentVolumeClaim (PVC)</strong>: A request for storage by a user or application. A PVC consumes PV resources. Kubernetes binds a PVC to an appropriate PV based on criteria like capacity, access modes, and <code>StorageClass</code>.</p>
</li>
<li>
<p><strong>StorageClass</strong>: Defines how storage is provisioned. It allows administrators to describe "classes" of storage (e.g., fast SSD storage, slower HDD storage, replicated storage). When a PVC requests a <code>StorageClass</code>, the appropriate provisioner is invoked to create the PV.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ActiveMQ Artemis stores several crucial pieces of data that require persistence:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Journal Files</strong>: These are the core of Artemis&#8217;s persistence mechanism, ensuring message durability. All incoming messages, transactions, and state changes are written to the journal before being acknowledged.</p>
</li>
<li>
<p><strong>Large Messages</strong>: Messages exceeding a certain size threshold (configurable) are stored directly on the filesystem rather than in memory.</p>
</li>
<li>
<p><strong>Bindings and Last Value Queue Data</strong>: Metadata about queues, topics, subscriptions, and last-value queue states.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When you deploy ActiveMQ Artemis using the OpenShift Operator, you configure persistent storage directly within the <code>ActiveMQArtemis</code> Custom Resource (CR). The Operator then takes care of creating the necessary `PersistentVolumeClaim`s and mounting them to the Artemis broker pods. This ensures that the journal files and other persistent data are stored on durable storage, surviving pod restarts, node failures, and even broker scaling operations.</p>
</div>
<div class="paragraph">
<p>Using persistent storage ensures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Message Durability</strong>: Messages are not lost even if the broker crashes or restarts.</p>
</li>
<li>
<p><strong>Broker State Preservation</strong>: Queue definitions, topic subscriptions, and other configurations are maintained.</p>
</li>
<li>
<p><strong>Fault Tolerance</strong>: In a clustered setup, if a broker fails, its persistent data can be recovered by another broker taking over.</p>
</li>
<li>
<p><strong>Scalability</strong>: Persistent volumes can be managed independently of the pods, facilitating scaling and rolling updates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The choice of <code>StorageClass</code> is important, as it dictates the performance and resilience characteristics of your storage. For production environments, it&#8217;s recommended to use a <code>StorageClass</code> backed by a highly available and performant storage solution, such as OpenShift Container Storage (Ceph RBD), AWS EBS, or similar cloud-provider specific block storage.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hands_on_lab_configuring_persistent_storage_for_an_activemq_artemis_cluster"><a class="anchor" href="#_hands_on_lab_configuring_persistent_storage_for_an_activemq_artemis_cluster"></a>Hands-on Lab: Configuring Persistent Storage for an ActiveMQ Artemis Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab, you will deploy a highly available ActiveMQ Artemis cluster on OpenShift with persistent storage enabled. We&#8217;ll leverage the ActiveMQ Artemis Operator to simplify the process.</p>
</div>
<div class="sect2">
<h3 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>An OpenShift cluster (version 4.x or newer).</p>
</li>
<li>
<p><code>oc</code> CLI tool configured to access your OpenShift cluster.</p>
</li>
<li>
<p>The ActiveMQ Artemis Operator installed in your OpenShift cluster. If not installed, please refer to the "Using the ActiveMQ Artemis Operator" section.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_lab_steps"><a class="anchor" href="#_lab_steps"></a>Lab Steps</h3>
<div class="sect3">
<h4 id="_step_1_examine_available_storageclasses"><a class="anchor" href="#_step_1_examine_available_storageclasses"></a>Step 1: Examine Available StorageClasses</h4>
<div class="paragraph">
<p>Before defining our Artemis broker, let&#8217;s see which `StorageClass`es are available in your OpenShift cluster. This will help you choose an appropriate one for your persistent volumes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get sc</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see output similar to this (actual <code>StorageClass</code> names may vary based on your cluster configuration):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">NAME                PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
gp2 (default)       kubernetes.io/aws-ebs   Delete          Immediate              true                   18d
ocs-storagecluster-cephfs   cephfs.csi.ceph.com     Delete          Immediate              true                   18d
ocs-storagecluster-ceph-rbd   rbd.csi.ceph.com        Delete          Immediate              true                   18d</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this lab, we&#8217;ll assume a <code>StorageClass</code> named <code>ocs-storagecluster-ceph-rbd</code> or <code>gp2</code> (if on AWS) is available, which provides block storage suitable for Artemis&#8217;s journal. If your cluster has a different default or preferred <code>StorageClass</code>, substitute it accordingly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_2_create_a_project_for_your_artemis_cluster"><a class="anchor" href="#_step_2_create_a_project_for_your_artemis_cluster"></a>Step 2: Create a Project for Your Artemis Cluster</h4>
<div class="paragraph">
<p>It&#8217;s good practice to create a dedicated project (namespace) for your application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc new-project artemis-persistent-cluster</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_step_3_deploy_an_activemq_artemis_cluster_with_persistent_storage"><a class="anchor" href="#_step_3_deploy_an_activemq_artemis_cluster_with_persistent_storage"></a>Step 3: Deploy an ActiveMQ Artemis Cluster with Persistent Storage</h4>
<div class="paragraph">
<p>Now, we will create an <code>ActiveMQArtemis</code> custom resource that configures a three-node cluster with persistent storage enabled.</p>
</div>
<div class="paragraph">
<p>Create a file named <code>artemis-persistent-cluster.yaml</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-persistent-broker
spec:
  deploymentPlan:
    size: 3 # Deploy a 3-node cluster
    image: registry.redhat.io/amq7/amq-broker-rhel8:7.12
    persistenceEnabled: true # Enable persistent storage
    journalType: nio # Use NIO journal for typical performance
    volumeStatus:
      storageClassName: ocs-storagecluster-ceph-rbd # Specify your StorageClass here
      size: 1Gi # Allocate 1GiB for each broker's journal
    # Define an accept connector for clients
    messageMigration:
      enabled: true # Enable message migration on broker shutdown/failure
    connectors:
      - name: my-acceptor
        port: 61616
        protocols: CORE,AMQP,JMS,MQTT,STOMP,HORNETQ
        # You can add further connector configurations as needed, e.g., discovery group

  # Configure Console
  console:
    expose: true
    sslEnabled: false # For lab purposes, disable SSL. Enable in production.

  # Configure Security (for lab, using default user for simplicity)
  brokerProperties:
    - security.login.config=activemq-jaas.config
    - 'security.roles.myuser=amq'
    - 'security.users.myuser=mypassword'

  # Expose the broker via a Route for client access
  externalVolumes: [] # No external volumes for this example
  addressSettings: [] # Default address settings

  # Expose a service for clients
  acceptors: [] # Connectors section handles acceptors
  # The operator automatically creates a headless service for intra-cluster communication
  # and a service for client access if expose is true in connectors.</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><code>persistenceEnabled: true</code></strong>: This crucial setting tells the Operator to provision persistent storage for the broker.</p>
</li>
<li>
<p><strong><code>journalType: nio</code></strong>: Specifies the journal type. <code>nio</code> is a common choice. <code>aio</code> provides higher performance but requires specific kernel modules.</p>
</li>
<li>
<p><strong><code>volumeStatus.storageClassName</code></strong>: This is where you specify the <code>StorageClass</code> you identified in Step 1. <strong>Ensure you replace <code>ocs-storagecluster-ceph-rbd</code> with an appropriate <code>StorageClass</code> available in your cluster.</strong></p>
</li>
<li>
<p><strong><code>volumeStatus.size</code></strong>: Defines the size of the <code>PersistentVolumeClaim</code> that will be created for each broker instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Apply this manifest to your OpenShift cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f artemis-persistent-cluster.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_step_4_verify_the_deployment_and_persistent_volumes"><a class="anchor" href="#_step_4_verify_the_deployment_and_persistent_volumes"></a>Step 4: Verify the Deployment and Persistent Volumes</h4>
<div class="paragraph">
<p>Monitor the creation of the ActiveMQ Artemis pods and the associated `PersistentVolumeClaim`s.</p>
</div>
<div class="paragraph">
<p>Check the `PersistentVolumeClaim`s:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pvc</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see three PVCs, one for each broker instance, similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS               AGE
my-persistent-broker-amq-0         Bound    pvc-12345678-abcd-11ef-ghij-klmnopqrst     1Gi        RWO            ocs-storagecluster-ceph-rbd   2m
my-persistent-broker-amq-1         Bound    pvc-abcdefgh-ijkl-mnop-qrst-uvwxyzabcdef   1Gi        RWO            ocs-storagecluster-ceph-rbd   2m
my-persistent-broker-amq-2         Bound    pvc-fedcba98-7654-3210-abcd-efgh01234567   1Gi        RWO            ocs-storagecluster-ceph-rbd   2m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the broker pods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until all three pods (<code>my-persistent-broker-amq-0</code>, <code>my-persistent-broker-amq-1</code>, <code>my-persistent-broker-amq-2</code>) are running.</p>
</div>
<div class="paragraph">
<p>Check the details of one of the pods to confirm the volume is mounted correctly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc describe pod my-persistent-broker-amq-0</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the output, look for the <code>Volumes</code> and <code>Volume Mounts</code> sections. You should see entries referring to the persistent volume mounted at <code>/opt/amq/data</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
Volumes:
  amq-data:
    Type: PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
    ClaimName: my-persistent-broker-amq-0
    ReadOnly: false
...
Volume Mounts:
  /opt/amq/data from amq-data (rw)
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This confirms that your ActiveMQ Artemis brokers are using persistent storage for their data, ensuring durability and reliability.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_5_test_persistence_optional"><a class="anchor" href="#_step_5_test_persistence_optional"></a>Step 5: Test Persistence (Optional)</h4>
<div class="paragraph">
<p>To further verify persistence, you can:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Send some messages to a queue on your Artemis broker.</p>
</li>
<li>
<p>Force delete one of the broker pods (e.g., <code>oc delete pod my-persistent-broker-amq-0</code>).</p>
</li>
<li>
<p>Observe that a new pod comes up, bound to the same <code>PersistentVolumeClaim</code>.</p>
</li>
<li>
<p>Reconnect your consumer and verify that the messages are still present and can be consumed, demonstrating that the data persisted across the pod recreation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This lab demonstrates how straightforward it is to configure persistent storage for ActiveMQ Artemis on OpenShift using the Operator and Kubernetes' native storage mechanisms. This setup forms the foundation for building highly resilient messaging applications.</p>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="custom-resource-definitions-crds-for-artemis.html">Custom Resource Definitions (CRDs) for Artemis</a></span>
  <span class="next"><a href="scaling-artemis-brokers-on-openshift.html">Scaling Artemis brokers on OpenShift</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
