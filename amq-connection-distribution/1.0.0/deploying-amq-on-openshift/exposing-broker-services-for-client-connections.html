<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Exposing broker services for client connections :: ActiveMQ Artemis Clustering for High-Performance Messaging</title>
    <link rel="prev" href="configuring-a-two-node-activemq-artemis-cluster.html">
    <link rel="next" href="../solutions-for-even-message-distribution/solutions-for-even-message-distribution.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">ActiveMQ Artemis Clustering for High-Performance Messaging</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="amq-connection-distribution" data-version="1.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">ActiveMQ Artemis Clustering for High-Performance Messaging</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../introduction-to-activemq-artemis/introduction-to-activemq-artemis.html">Introduction to ActiveMQ Artemis</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction-to-activemq-artemis/understanding-message-oriented-middleware-mom.html">Understanding Message-Oriented Middleware (MOM)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction-to-activemq-artemis/core-features-and-benefits-of-activemq-artemis.html">Core features and benefits of ActiveMQ Artemis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction-to-activemq-artemis/decoupling-producers-and-consumers.html">Decoupling Producers and Consumers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction-to-activemq-artemis/asynchronous-communication-patterns.html">Asynchronous communication patterns</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction-to-activemq-artemis/traffic-smoothing-and-competing-consumers.html">Traffic smoothing and competing consumers</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../client-side-challenges/client-side-challenges.html">Client-Side Challenges</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-challenges/bottlenecks-from-single-connection-to-a-single-broker.html">Bottlenecks from single connection to a single broker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-challenges/impact-of-default-client-load-balancing-policies.html">Impact of default client load-balancing policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-challenges/reduced-cluster-throughput-due-to-message-redistribution.html">Reduced cluster throughput due to message redistribution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-challenges/risk-of-high-volume-queues-paging-messages-to-disk.html">Risk of high-volume queues paging messages to disk</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="deploying-amq-on-openshift.html">Deploying AMQ on OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="overview-of-red-hat-amq-operator.html">Overview of Red Hat AMQ Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installing-the-amq-operator-on-openshift.html">Installing the AMQ Operator on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="creating-an-activemqartemis-custom-resource-cr.html">Creating an ActiveMQArtemis Custom Resource (CR)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuring-a-two-node-activemq-artemis-cluster.html">Configuring a two-node ActiveMQ Artemis cluster</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="exposing-broker-services-for-client-connections.html">Exposing broker services for client connections</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../solutions-for-even-message-distribution/solutions-for-even-message-distribution.html">Solutions for Even Message Distribution</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../solutions-for-even-message-distribution/strategies-for-client-side-load-balancing.html">Strategies for client-side load balancing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../solutions-for-even-message-distribution/configuring-client-connection-factories-for-multiple-brokers.html">Configuring client connection factories for multiple brokers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../solutions-for-even-message-distribution/techniques-to-distribute-messages-evenly-across-cluster-members.html">Techniques to distribute messages evenly across cluster members</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../solutions-for-even-message-distribution/optimizing-client-connectivity-for-high-throughput.html">Optimizing client connectivity for high throughput</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../hands-on-lab-deploying-and-interacting-with-an-activemq-artemis-cluster/hands-on-lab-deploying-and-interacting-with-an-activemq-artemis-cluster.html">Hands-on Lab: Deploying and Interacting with an ActiveMQ Artemis Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hands-on-lab-deploying-and-interacting-with-an-activemq-artemis-cluster/setting-up-the-openshift-environment-for-amq-deployment.html">Setting up the OpenShift environment for AMQ deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hands-on-lab-deploying-and-interacting-with-an-activemq-artemis-cluster/deploying-a-two-node-activemq-artemis-cluster-using-the-operator.html">Deploying a two-node ActiveMQ Artemis cluster using the Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hands-on-lab-deploying-and-interacting-with-an-activemq-artemis-cluster/developing-and-deploying-client-applications.html">Developing and deploying client applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hands-on-lab-deploying-and-interacting-with-an-activemq-artemis-cluster/observing-message-distribution-and-cluster-behavior.html">Observing message distribution and cluster behavior</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hands-on-lab-deploying-and-interacting-with-an-activemq-artemis-cluster/testing-failover-scenarios-and-ha-capabilities.html">Testing failover scenarios and HA capabilities</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ActiveMQ Artemis Clustering for High-Performance Messaging</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">ActiveMQ Artemis Clustering for High-Performance Messaging</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">ActiveMQ Artemis Clustering for High-Performance Messaging</a></li>
    <li><a href="deploying-amq-on-openshift.html">Deploying AMQ on OpenShift</a></li>
    <li><a href="exposing-broker-services-for-client-connections.html">Exposing broker services for client connections</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Exposing broker services for client connections</h1>
<h1 id="_exposing_broker_services_for_client_connections" class="sect0"><a class="anchor" href="#_exposing_broker_services_for_client_connections"></a>Exposing Broker Services for Client Connections</h1>
<div class="paragraph">
<p>To enable client applications to connect and interact with an ActiveMQ Artemis cluster deployed on OpenShift, it is essential to expose the broker services. This allows external clients, running outside the OpenShift cluster&#8217;s internal network, to establish connections for sending and receiving messages.</p>
</div>
<div class="sect1">
<h2 id="_technical_explanation_the_need_for_exposed_services"><a class="anchor" href="#_technical_explanation_the_need_for_exposed_services"></a>Technical Explanation: The Need for Exposed Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In an OpenShift environment, pods and services are typically isolated within the cluster&#8217;s network. For client applications to reach the ActiveMQ Artemis brokers, a mechanism must be in place to expose these internal services externally. The Red Hat AMQ Operator simplifies this process by allowing direct configuration within the <code>ActiveMQArtemis</code> Custom Resource (CR).</p>
</div>
<div class="paragraph">
<p>Each ActiveMQ Artemis broker within a cluster operates independently, capable of serving clients. When an <code>ActiveMQArtemis</code> CR is configured with <code>size: 2</code> (as indicated in the context), two broker pods are created, forming a cluster. Each of these brokers is configured with "acceptors" that listen for incoming client connections on specific ports.</p>
</div>
<div class="paragraph">
<p>The context states:
&#8220;This will create two broker pods in a cluster where each can serve the clients independently and this create a problem for the clients especially when the consumer is not long lasting or disconnects frequently.&#8221;</p>
</div>
<div class="paragraph">
<p>This independent handling by each broker can lead to a <strong>connection disparity</strong> across the cluster nodes. Modern application frameworks, such as Spring Boot or Quarkus, often manage connections on demand. If client applications connect primarily to a single broker (due to default load-balancing policies or transient connections), that broker might accumulate a disproportionate number of connections and, consequently, a higher volume of messages.</p>
</div>
<div class="paragraph">
<p>Consider the queue statistics from two different broker nodes in the cluster (as provided in the context):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">&gt;&gt;&gt; Queue stats on node e779f217-d741-11f0-906c-0a580ad9003a,
url=tcp://broker-ss-1.broker-hdls-svc.broker.svc.cluster.local:61616
|NAME  |ADDRESS|CONSUMER|MESSAGE|MESSAGES|DELIVERING|MESSAGES|SCHEDULED|ROUTING|INTERNAL|
|      |       | COUNT  | COUNT | ADDED  |  COUNT   | ACKED  |  COUNT  | TYPE  |        |
|prices|prices |   2    |   0   |  188   |    0     |  188   |    0    |ANYCAST| false  |</code></pre>
</div>
</div>
<div class="paragraph">
<p>And for another node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">&gt;&gt;&gt; Queue stats on node da5317e0-d741-11f0-aa76-0a580ad90038,
url=tcp://broker-ss-0:61616
|NAME  |ADDRESS|CONSUMER|MESSAGE|MESSAGES|DELIVERING|MESSAGES|SCHEDULED|ROUTING|INTERNAL|
|      |       | COUNT  | COUNT | ADDED  |  COUNT   | ACKED  |  COUNT  | TYPE  |        |
|prices|prices |   3    |   0   |  210   |    0     |  210   |    0    |ANYCAST| false  |</code></pre>
</div>
</div>
<div class="paragraph">
<p>These statistics illustrate that even with a simple <code>prices</code> queue, one node (<code>da5317e0-d741-11f0-aa76-0a580ad90038</code>) has 3 consumers and has processed 210 messages, while the other (<code>e779f217-d741-11f0-906c-0a580ad9003a</code>) has 2 consumers and handled 188 messages. This difference, though small here, can become significant under high load and contribute to uneven resource utilization and potential bottlenecks, especially when client-side load balancing is not explicitly configured.</p>
</div>
<div class="paragraph">
<p>To expose broker services for client connections, the <code>acceptors</code> section within the <code>ActiveMQArtemis</code> CR is used. This section defines how the broker listens for connections. Key parameters include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code>: A unique identifier for the acceptor.</p>
</li>
<li>
<p><code>port</code>: The port number on which the broker listens. Standard AMQP/Artemis ports are often used (e.g., 61616 for OpenWire, 61617 for AMQP).</p>
</li>
<li>
<p><code>expose</code>: A boolean flag (<code>true</code> or <code>false</code>) that dictates whether OpenShift should create a Route or LoadBalancer Service (depending on the cluster configuration) to expose this port externally.</p>
</li>
<li>
<p><code>sslEnabled</code>: A boolean flag to enable SSL/TLS encryption for the connection.</p>
</li>
<li>
<p><code>sslSecret</code>: The name of the Kubernetes <code>Secret</code> that contains the TLS certificate and private key for secure connections.</p>
</li>
<li>
<p><code>connectionsAllowed</code>: The maximum number of client connections allowed for this acceptor. A value of <code>-1</code> means unlimited connections.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By setting <code>expose: true</code>, the AMQ Operator automatically provisions the necessary OpenShift resources to make the broker&#8217;s acceptor accessible from outside the cluster, typically via a hostname and port.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hands_on_activity_configuring_and_exposing_broker_services"><a class="anchor" href="#_hands_on_activity_configuring_and_exposing_broker_services"></a>Hands-on Activity: Configuring and Exposing Broker Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This activity demonstrates how to configure the <code>ActiveMQArtemis</code> Custom Resource to expose broker services, including secure connections, for client access.</p>
</div>
<div class="sect2">
<h3 id="_step_1_define_an_acceptor_in_the_activemqartemis_cr"><a class="anchor" href="#_step_1_define_an_acceptor_in_the_activemqartemis_cr"></a>Step 1: Define an Acceptor in the ActiveMQArtemis CR</h3>
<div class="paragraph">
<p>You will modify your <code>ActiveMQArtemis</code> Custom Resource to include an <code>acceptor</code> configuration that exposes the broker service. This configuration will enable secure connections (SSL/TLS) for clients.</p>
</div>
<div class="paragraph">
<div class="title">Create or update an <code>ActiveMQArtemis</code> Custom Resource (CR) with the following <code>acceptors</code> section. If you already have a CR, integrate this section into it.</div>
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-broker
spec:
  deploymentPlan:
    size: 2 # Ensure a clustered deployment
    image: placeholder # Replace with actual image if needed
    persistenceEnabled: false # For demonstration purposes, or true for production
    journalType: nio
    managementRBACEnabled: true
    jolokiaAgentEnabled: false
    requireLogin: false
  addressSettings:
    addressSetting:
      - match: '#'
        redistributionDelay: 0
  console:
    expose: true # Expose the management console
  acceptors: # This section defines how clients connect
    - name: broker # Name of the acceptor
      port: 61617 # Port for client connections (e.g., AMQP)
      expose: true # Set to true to expose this acceptor externally
      sslEnabled: true # Enable SSL/TLS for secure connections
      sslSecret: tls # Reference to the Kubernetes Secret containing TLS certs
      connectionsAllowed: -1 # Allow unlimited connections</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Explanation of the <code>acceptors</code> configuration:</div>
<ul>
<li>
<p>The <code>broker</code> acceptor will listen on port <code>61617</code>.</p>
</li>
<li>
<p><code>expose: true</code> ensures that OpenShift will create a service and route (or LoadBalancer) to make <code>my-broker</code> accessible from outside the cluster.</p>
</li>
<li>
<p><code>sslEnabled: true</code> and <code>sslSecret: tls</code> mandate that clients connect using SSL/TLS, using the certificates provided in the <code>tls</code> Kubernetes secret. You must ensure a <code>Secret</code> named <code>tls</code> exists in the same namespace, containing the appropriate <code>tls.crt</code> and <code>tls.key</code>.</p>
</li>
<li>
<p><code>connectionsAllowed: -1</code> allows an unlimited number of client connections to this specific acceptor.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_apply_the_configuration"><a class="anchor" href="#_step_2_apply_the_configuration"></a>Step 2: Apply the Configuration</h3>
<div class="paragraph">
<p>Apply the updated <code>ActiveMQArtemis</code> CR to your OpenShift cluster.</p>
</div>
<div class="paragraph">
<div class="title">Apply the YAML file using <code>oc apply</code>:</div>
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;your-artemis-cr-file&gt;.yaml</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">The Red Hat AMQ Operator will detect the changes in the CR and perform the following actions:</div>
<ul>
<li>
<p>Ensure the two broker pods are running (if <code>size: 2</code>).</p>
</li>
<li>
<p>Configure each broker with the specified <code>acceptor</code> on port <code>61617</code>.</p>
</li>
<li>
<p>Create an OpenShift <code>Service</code> and potentially a <code>Route</code> (for HTTP/HTTPS, or a LoadBalancer service for TCP) to expose the <code>broker</code> acceptor externally.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_verify_the_exposed_services"><a class="anchor" href="#_step_3_verify_the_exposed_services"></a>Step 3: Verify the Exposed Services</h3>
<div class="paragraph">
<p>After applying the CR, verify that the services have been exposed correctly and obtain the external connection details.</p>
</div>
<div class="paragraph">
<div class="title">Check the services created by the Operator:</div>
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get svc -l app.kubernetes.io/name=my-broker</code></pre>
</div>
</div>
<div class="paragraph">
<p>+
You should see services related to <code>my-broker</code>, including the headless service (<code>-hdls-svc</code>) and potentially a <code>Service</code> or <code>Route</code> exposing the <code>broker</code> acceptor on port 61617.</p>
</div>
<div class="paragraph">
<div class="title">Check the routes created (if using OpenShift Routes):</div>
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -l app.kubernetes.io/name=my-broker</code></pre>
</div>
</div>
<div class="paragraph">
<p>+
Look for routes associated with the <code>broker</code> acceptor. These routes will provide the external hostname that clients can use to connect. The AMQ Operator often creates specific routes for each exposed acceptor, typically following a naming convention like <code>&lt;broker-name&gt;-&lt;acceptor-name&gt;</code>.</p>
</div>
<div class="paragraph">
<div class="title">Example Output (Routes):</div>
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">NAME                HOST/PORT                                   PATH   SERVICES            PORT       TERMINATION   WILDCARD
my-broker-broker    my-broker-broker-broker.apps.example.com           my-broker-hdls-svc  61617      passthrough   None
my-broker-console   my-broker-console-broker.apps.example.com          my-broker-hdls-svc  webconsole passthrough   None</code></pre>
</div>
</div>
<div class="paragraph">
<p>+
In this example, <code>my-broker-broker.apps.example.com</code> is the external hostname clients would use to connect securely on port 61617.</p>
</div>
<div class="paragraph">
<p>With the broker services exposed, client applications can now connect to the ActiveMQ Artemis cluster. The next challenge is to ensure these client connections are balanced across all available broker nodes to achieve even message distribution and optimal performance.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="configuring-a-two-node-activemq-artemis-cluster.html">Configuring a two-node ActiveMQ Artemis cluster</a></span>
  <span class="next"><a href="../solutions-for-even-message-distribution/solutions-for-even-message-distribution.html">Solutions for Even Message Distribution</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
