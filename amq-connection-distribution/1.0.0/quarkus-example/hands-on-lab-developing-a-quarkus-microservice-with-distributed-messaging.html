<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hands-on Lab: Developing a Quarkus microservice with distributed messaging :: Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</title>
    <link rel="prev" href="deploying-quarkus-messaging-applications-on-openshift.html">
    <link rel="next" href="../spring-boot-example/spring-boot-example.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="amq-connection-distribution" data-version="1.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../deploying-activemq-artemis-on-openshift/deploying-activemq-artemis-on-openshift.html">Deploying ActiveMQ Artemis on OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploying-activemq-artemis-on-openshift/introduction-to-openshift-for-messaging-applications.html">Introduction to OpenShift for messaging applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploying-activemq-artemis-on-openshift/understanding-activemq-artemis-on-openshift.html">Understanding ActiveMQ Artemis on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploying-activemq-artemis-on-openshift/using-the-activemq-artemis-operator.html">Using the ActiveMQ Artemis Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploying-activemq-artemis-on-openshift/custom-resource-definitions-crds-for-artemis.html">Custom Resource Definitions (CRDs) for Artemis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploying-activemq-artemis-on-openshift/configuring-persistent-storage-for-artemis.html">Configuring persistent storage for Artemis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploying-activemq-artemis-on-openshift/scaling-artemis-brokers-on-openshift.html">Scaling Artemis brokers on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploying-activemq-artemis-on-openshift/monitoring-artemis-instances-on-openshift.html">Monitoring Artemis instances on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploying-activemq-artemis-on-openshift/hands-on-lab-deploying-a-highly-available-activemq-artemis-cluster-on-openshift.html">Hands-on Lab: Deploying a highly available ActiveMQ Artemis cluster on OpenShift</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../message-distribution-issues/message-distribution-issues.html">Message distribution issues</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/understanding-distributed-messaging-patterns.html">Understanding distributed messaging patterns</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/load-balancing-messages-across-consumers.html">Load balancing messages across consumers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/message-routing-strategies-and-challenges.html">Message routing strategies and challenges</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/consumer-groups-and-shared-subscriptions.html">Consumer groups and shared subscriptions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/ensuring-message-ordering-in-distributed-systems.html">Ensuring message ordering in distributed systems</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/handling-message-durability-and-reliability.html">Handling message durability and reliability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../message-distribution-issues/addressing-fault-tolerance-and-high-availability-for-messages.html">Addressing fault tolerance and high availability for messages</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../client-side-solution/client-side-solution.html">Client Side Solution</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/client-side-connection-management-and-pooling.html">Client-side connection management and pooling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/implementing-client-failover-mechanisms.html">Implementing client failover mechanisms</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/client-side-load-balancing-for-message-consumption.html">Client-side load balancing for message consumption</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/message-acknowledgment-patterns-auto_acknowledge-client_acknowledge.html">Message acknowledgment patterns (AUTO_ACKNOWLEDGE, CLIENT_ACKNOWLEDGE)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/transaction-management-for-message-producers-and-consumers.html">Transaction management for message producers and consumers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client-side-solution/best-practices-for-client-integration-with-distributed-brokers.html">Best practices for client integration with distributed brokers</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="quarkus-example.html">Quarkus Example</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="integrating-jmsamqp-clients-with-quarkus.html">Integrating JMS/AMQP clients with Quarkus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuring-quarkus-for-activemq-artemis-connectivity.html">Configuring Quarkus for ActiveMQ Artemis connectivity</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="implementing-message-producers-in-quarkus.html">Implementing message producers in Quarkus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="implementing-message-consumers-in-quarkus.html">Implementing message consumers in Quarkus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reactive-messaging-with-quarkus-and-artemis.html">Reactive messaging with Quarkus and Artemis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deploying-quarkus-messaging-applications-on-openshift.html">Deploying Quarkus messaging applications on OpenShift</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="hands-on-lab-developing-a-quarkus-microservice-with-distributed-messaging.html">Hands-on Lab: Developing a Quarkus microservice with distributed messaging</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../spring-boot-example/spring-boot-example.html">Spring Boot Example</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/integrating-jmsamqp-clients-with-spring-boot.html">Integrating JMS/AMQP clients with Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/configuring-spring-boot-for-activemq-artemis-connectivity.html">Configuring Spring Boot for ActiveMQ Artemis connectivity</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/using-spring-jmsamqp-templates-for-messaging.html">Using Spring JMS/AMQP templates for messaging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/implementing-message-producers-in-spring-boot.html">Implementing message producers in Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/implementing-message-consumers-in-spring-boot.html">Implementing message consumers in Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/configuring-listener-containers-and-concurrency.html">Configuring listener containers and concurrency</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/deploying-spring-boot-messaging-applications-on-openshift.html">Deploying Spring Boot messaging applications on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot-example/hands-on-lab-developing-a-spring-boot-microservice-with-distributed-messaging.html">Hands-on Lab: Developing a Spring Boot microservice with distributed messaging</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Resilient Messaging Applications with ActiveMQ Artemis and OpenShift</a></li>
    <li><a href="quarkus-example.html">Quarkus Example</a></li>
    <li><a href="hands-on-lab-developing-a-quarkus-microservice-with-distributed-messaging.html">Hands-on Lab: Developing a Quarkus microservice with distributed messaging</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Hands-on Lab: Developing a Quarkus microservice with distributed messaging</h1>
<h1 id="_hands_on_lab_developing_a_quarkus_microservice_with_distributed_messaging" class="sect0"><a class="anchor" href="#_hands_on_lab_developing_a_quarkus_microservice_with_distributed_messaging"></a>Hands-on Lab: Developing a Quarkus Microservice with Distributed Messaging</h1>
<div class="paragraph">
<p>This lab guides you through building a Quarkus microservice that interacts with an ActiveMQ Artemis cluster deployed on OpenShift. You will learn how to integrate Quarkus with Artemis using its reactive messaging capabilities (powered by SmallRye Reactive Messaging), implement message producers and consumers, and deploy the application to OpenShift. This hands-on experience will solidify your understanding of building resilient, event-driven microservices.</p>
</div>
<div class="sect1">
<h2 id="_objectives"><a class="anchor" href="#_objectives"></a>Objectives</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upon completion of this lab, you will be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Integrate the SmallRye Reactive Messaging AMQP connector with a Quarkus application.</p>
</li>
<li>
<p>Configure Quarkus for ActiveMQ Artemis connectivity, including secure connections over OpenShift Routes.</p>
</li>
<li>
<p>Implement message producers to send messages to Artemis queues or topics.</p>
</li>
<li>
<p>Implement message consumers to receive and process messages from Artemis with explicit acknowledgment.</p>
</li>
<li>
<p>Deploy a Quarkus messaging application to OpenShift using Quarkus&#8217;s built-in OpenShift extension.</p>
</li>
<li>
<p>Verify end-to-end message flow between the Quarkus application and the Artemis broker on OpenShift.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before starting this lab, ensure you have the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>OpenShift Cluster Access</strong>: An OpenShift cluster (4.x or newer) with <code>oc</code> CLI configured and logged in. You should have permissions to create projects and deploy applications.</p>
</li>
<li>
<p><strong>ActiveMQ Artemis Cluster</strong>: An ActiveMQ Artemis cluster deployed and running on OpenShift. This lab assumes you have already completed the "Hands-on Lab: Deploying a highly available ActiveMQ Artemis cluster on OpenShift" and have an accessible Artemis broker.</p>
</li>
<li>
<p><strong>Java Development Kit (JDK)</strong>: Java 11 or newer installed and configured.</p>
</li>
<li>
<p><strong>Apache Maven</strong>: Apache Maven 3.8+ installed.</p>
</li>
<li>
<p><strong>Text Editor or IDE</strong>: A text editor or Integrated Development Environment (IDE) like VS Code or IntelliJ IDEA.</p>
</li>
<li>
<p><strong>Basic Understanding</strong>: Familiarity with Quarkus, OpenShift fundamentals, and basic messaging concepts.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_setup"><a class="anchor" href="#_lab_setup"></a>Lab Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first step is to gather the necessary connection details for your ActiveMQ Artemis broker deployed on OpenShift.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Retrieve ActiveMQ Artemis Broker Connection Information</strong></p>
<div class="literalblock">
<div class="content">
<pre>You need the hostname and authentication details for your deployed ActiveMQ Artemis cluster. If you followed the previous lab, your broker's AMQP port should be exposed via an OpenShift `Route`.</pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Log in to the Artemis project</strong>:
<code><code>bash
oc project amq-artemis-project # Replace with the actual namespace where Artemis is deployed
</code></code></p>
</li>
<li>
<p><strong>Get the AMQP Route</strong>:
Look for a route that exposes the AMQP protocol. This is typically named similar to <code>artemis-broker-0-amqp</code> or <code>amq-broker-amqp</code>.</p>
<div class="literalblock">
<div class="content">
<pre>```bash
oc get route -o custom-columns=NAME:.metadata.name,HOST/PORT:.spec.host,SERVICE:.spec.to.name,PORT:.spec.port.targetPort
```
*Example Output:*
```
NAME                         HOST/PORT                                                                SERVICE          PORT
artemis-broker-0-amqp        artemis-broker-0-amqp-amq-artemis-project.apps.cluster.example.com         artemis-broker-0   amqp
```
Note down the `HOST/PORT` for the AMQP route. This will be your `ARTEMIS_BROKER_HOST`. Given it's an OpenShift Route, it will likely be accessible over standard HTTPS/WSS port 443, and `use-ssl` will be required.</pre>
</div>
</div>
</li>
<li>
<p><strong>Retrieve Artemis Credentials</strong>:
The Artemis broker usually has a user created with a corresponding password. If you used the <code>amq-broker</code> template, these might be in a secret. The default often used in labs is <code>admin</code> for both username and password. Confirm these details from your Artemis deployment. For this lab, we will assume <code>admin</code>/<code>admin</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_1_create_a_new_quarkus_project"><a class="anchor" href="#_step_1_create_a_new_quarkus_project"></a>Step 1: Create a New Quarkus Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will generate a new Quarkus project and include the necessary extensions for reactive messaging with AMQP.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Generate the Quarkus Project</strong></p>
<div class="literalblock">
<div class="content">
<pre>Use the Quarkus Maven plugin to create a new project. We will include `quarkus-resteasy-reactive` (for the REST endpoint) and `quarkus-smallrye-reactive-messaging-amqp` (for AMQP messaging).</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```bash
mvn io.quarkus.platform:quarkus-maven-plugin:3.8.3:create \
    -DprojectGroupId=com.example \
    -DprojectArtifactId=quarkus-artemis-messaging \
    -Dextensions="resteasy-reactive,smallrye-reactive-messaging-amqp" \
    -DnoTests
```
(Note: You can adjust the `3.8.3` Quarkus version to a newer stable version if desired.)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Navigate into your newly created project directory:
```bash
cd quarkus-artemis-messaging
```</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_2_configure_activemq_artemis_connectivity"><a class="anchor" href="#_step_2_configure_activemq_artemis_connectivity"></a>Step 2: Configure ActiveMQ Artemis Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, configure your Quarkus application to establish a connection to the ActiveMQ Artemis broker using the details gathered in the setup phase.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Edit <code>src/main/resources/application.properties</code></strong></p>
<div class="literalblock">
<div class="content">
<pre>Open the `application.properties` file and add the following configuration. Replace `ARTEMIS_BROKER_HOST` with the actual hostname you retrieved earlier.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```properties
# Quarkus HTTP Port for the application's REST endpoint
quarkus.http.port=8080</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># Reactive Messaging AMQP Connector Configuration
# This configures the default AMQP broker connection parameters.
# The 'amqp' connector is an alias for 'smallrye-amqp' when using the default AMQP extension.
mp.messaging.connector.amqp.host=ARTEMIS_BROKER_HOST
mp.messaging.connector.amqp.port=443 # Default HTTPS port for OpenShift Routes. Use 5672 if connecting directly to a Service.
mp.messaging.connector.amqp.use-ssl=true # Set to true when connecting via an OpenShift Route (HTTPS/WSS).
mp.messaging.connector.amqp.username=admin # Replace with your Artemis username
mp.messaging.connector.amqp.password=admin # Replace with your Artemis password
mp.messaging.connector.amqp.sasl-mechanism=PLAIN # Recommended for simple username/password auth
mp.messaging.connector.amqp.client-id=quarkus-messaging-client # A unique client ID for the connection</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># Optionally, for detailed logging from the AMQP connector:
# quarkus.log.category."io.smallrye.reactive.messaging.amqp".level=DEBUG
```</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Important</strong>: Ensure <code>ARTEMIS_BROKER_HOST</code>, <code>username</code>, and <code>password</code> are correctly set for your Artemis deployment. If <code>use-ssl</code> is set to <code>true</code>, the <code>port</code> should typically be <code>443</code> for routes. If you expose a direct AMQP service without TLS termination at the route, the port might be <code>5672</code> (or the specific AMQP service port) and <code>use-ssl=false</code>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_3_implement_a_message_producer"><a class="anchor" href="#_step_3_implement_a_message_producer"></a>Step 3: Implement a Message Producer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s create a simple REST endpoint that, when called, sends a message to a specific Artemis address (e.g., a queue).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Create a Producer Service</strong></p>
<div class="literalblock">
<div class="content">
<pre>Create a new Java class `src/main/java/com/example/PriceProducer.java` with the following content:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```java
package com.example;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>import io.smallrye.reactive.messaging.annotations.Channel;
import io.smallrye.reactive.messaging.annotations.Emitter;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;
import java.util.Random;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>/**
 * A Quarkus resource that acts as a message producer.
 * It exposes a REST endpoint to trigger message sending to an AMQP broker.
 */
@ApplicationScoped
@Path("/prices")
public class PriceProducer {</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>// Injects an Emitter for the "prices-out" channel.
// This channel is configured in application.properties to send messages to Artemis.
@Channel("prices-out")
Emitter&lt;Double&gt; priceEmitter;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>private final Random random = new Random();</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>/**
 * REST endpoint to manually trigger message sending.
 * Calls to this endpoint will generate a random price and send it to the 'prices-out' channel.
 *
 * @return A confirmation message.
 */
@GET
@Path("/send")
@Produces(MediaType.TEXT_PLAIN)
public String sendPrice() {
    double price = generatePrice();
    priceEmitter.send(price); // Sends the message. SmallRye Reactive Messaging handles the AMQP interaction.
    System.out.println("Producer sent price: " + price);
    return "Price " + String.format("%.2f", price) + " sent!";
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    /**
     * Generates a random price between 100.0 and 110.0.
     *
     * @return A randomly generated price.
     */
    private double generatePrice() {
        return 100.0 + random.nextDouble() * 10.0;
    }
}
```</pre>
</div>
</div>
</li>
<li>
<p><strong>Configure the Outgoing Channel in <code>application.properties</code></strong></p>
<div class="literalblock">
<div class="content">
<pre>Add the following to `src/main/resources/application.properties` to map the `prices-out` channel to an AMQP address (e.g., a queue named `prices`).</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```properties
# Reactive Messaging Outgoing Channel Configuration
# This defines how messages sent to the "prices-out" channel are handled.
mp.messaging.outgoing.prices-out.connector=smallrye-amqp # Specifies the AMQP connector
mp.messaging.outgoing.prices-out.address=prices # The target AMQP address (queue or topic) on Artemis
mp.messaging.outgoing.prices-out.durable=true # Ensures messages sent are durable on the broker side
mp.messaging.outgoing.prices-out.type=queue # Explicitly declare as a queue (optional, but good practice)
```</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_4_implement_a_message_consumer"><a class="anchor" href="#_step_4_implement_a_message_consumer"></a>Step 4: Implement a Message Consumer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Next, create a service that listens for messages on the specified Artemis address and processes them.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Create a Consumer Service</strong></p>
<div class="literalblock">
<div class="content">
<pre>Create a new Java class `src/main/java/com/example/PriceConsumer.java`:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```java
package com.example;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>import io.smallrye.reactive.messaging.annotations.Incoming;
import jakarta.enterprise.context.ApplicationScoped;
import org.eclipse.microprofile.reactive.messaging.Acknowledgment;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>/**
 * A Quarkus application scoped bean that acts as a message consumer.
 * It listens for messages on a specific AMQP channel and processes them.
 */
@ApplicationScoped
public class PriceConsumer {</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    /**
     * Consumes messages from the "prices-in" channel.
     * The @Incoming annotation maps this method to the configured incoming channel.
     * The @Acknowledgment.Strategy.POST_COMMIT ensures messages are acknowledged
     * only after the consume method completes successfully.
     *
     * @param price The Double message payload received from the AMQP broker.
     */
    @Incoming("prices-in")
    @Acknowledgment(Acknowledgment.Strategy.POST_COMMIT)
    public void consume(Double price) {
        System.out.println("Consumer received price: " + String.format("%.2f", price));
        // In a real-world application, this is where you would implement
        // business logic, such as:
        // - Storing the price in a database
        // - Updating a UI or dashboard
        // - Triggering further actions based on the price
    }
}
```</pre>
</div>
</div>
</li>
<li>
<p><strong>Configure the Incoming Channel in <code>application.properties</code></strong></p>
<div class="literalblock">
<div class="content">
<pre>Add the following to `src/main/resources/application.properties` to map the `prices-in` channel to the same AMQP address `prices`.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```properties
# Reactive Messaging Incoming Channel Configuration
# This defines how messages are consumed from the "prices-in" channel.
mp.messaging.incoming.prices-in.connector=smallrye-amqp # Specifies the AMQP connector
mp.messaging.incoming.prices-in.address=prices # The source AMQP address (queue or topic) on Artemis
mp.messaging.incoming.prices-in.durable=true # Connects to a durable subscription/queue
mp.messaging.incoming.prices-in.credit=10 # Configures prefetch: Consumer will request 10 messages at a time
mp.messaging.incoming.prices-in.auto-acknowledgement=false # Explicit acknowledgment (handled by @Acknowledgment.Strategy.POST_COMMIT)
mp.messaging.incoming.prices-in.broadcast=false # For queues, ensures messages are consumed exclusively by one consumer instance
mp.messaging.incoming.prices-in.type=queue # Explicitly declare as a queue
```
*   `auto-acknowledgement=false` combined with `@Acknowledgment(Acknowledgment.Strategy.POST_COMMIT)` is crucial for "at-least-once" delivery semantics. It ensures the message is only acknowledged back to Artemis after the `consume` method has successfully completed its processing. If an error occurs, the message will not be acknowledged and can be redelivered.</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_5_run_and_test_locally_optional_but_recommended"><a class="anchor" href="#_step_5_run_and_test_locally_optional_but_recommended"></a>Step 5: Run and Test Locally (Optional but Recommended)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before deploying to OpenShift, it&#8217;s highly recommended to test the application locally to ensure basic messaging functionality.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Run the Quarkus Application in Dev Mode</strong></p>
<div class="literalblock">
<div class="content">
<pre>From your project root directory, execute:
```bash
mvn quarkus:dev
```
Quarkus will start in development mode, watching for code changes and automatically recompiling. You should see output indicating it's running:
```
__  ____  __  _____   ___  __ ____  ______
--/ __ \/ / / / _ | / _ \/ //_/ / / / __/
-/ /_/ / /_/ / __ |/ , _/ ,&lt; / /_/ /\ \
--\___\_\____/_/ |_/_/|_/_/|_|\____/___/
...
quarkus:dev is up and running!
```
Your Quarkus application is now connected to the remote ActiveMQ Artemis broker.</pre>
</div>
</div>
</li>
<li>
<p><strong>Test Message Production and Consumption</strong></p>
<div class="literalblock">
<div class="content">
<pre>Open a *new terminal* and use `curl` to trigger the producer endpoint on your local machine:
```bash
curl http://localhost:8080/prices/send
```
You should see a confirmation message like "Price 105.12 sent!" in the `curl` terminal.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Now, observe the terminal where `mvn quarkus:dev` is running. You should see two lines of output for each `curl` request:
```
Producer sent price: 105.12345
Consumer received price: 105.12
```
This indicates that your local Quarkus application successfully sent a message to the remote Artemis broker, and then the *same local application* (acting as a consumer) successfully received it from Artemis. This confirms the end-to-end local connectivity and messaging logic.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Press `q` in the `mvn quarkus:dev` terminal to stop the application.</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_6_deploy_to_openshift"><a class="anchor" href="#_step_6_deploy_to_openshift"></a>Step 6: Deploy to OpenShift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus provides excellent integration for deploying applications to OpenShift by automatically generating Kubernetes/OpenShift manifests and building container images.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Add OpenShift Extension</strong></p>
<div class="literalblock">
<div class="content">
<pre>First, add the Quarkus OpenShift extension to your project. This enables Quarkus to generate the necessary deployment manifests.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```bash
mvn quarkus:add-extension -Dextensions="openshift"
```</pre>
</div>
</div>
</li>
<li>
<p><strong>Create a New OpenShift Project for Your Application</strong></p>
<div class="literalblock">
<div class="content">
<pre>It's good practice to deploy your application into its own OpenShift project, separate from the Artemis broker.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```bash
oc new-project my-quarkus-app-project # Choose a meaningful name for your application project
```
Switch to this project:
```bash
oc project my-quarkus-app-project
```</pre>
</div>
</div>
</li>
<li>
<p><strong>Build and Deploy to OpenShift</strong></p>
<div class="literalblock">
<div class="content">
<pre>Use the Quarkus Maven plugin to build your application, create a container image, and deploy it directly to the OpenShift project you just created.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```bash
mvn clean package -Dquarkus.container-image.build=true -Dquarkus.kubernetes.deploy=true -Dquarkus.kubernetes.deployment-target=openshift
```
This command performs several actions:
*   `clean package`: Builds the Quarkus application into an executable JAR.
*   `-Dquarkus.container-image.build=true`: Instructs Quarkus to build a container image for the application.
*   `-Dquarkus.kubernetes.deploy=true`: Tells Quarkus to deploy the generated resources to the current Kubernetes/OpenShift context.
*   `-Dquarkus.kubernetes.deployment-target=openshift`: Specifies that the deployment target is OpenShift, generating appropriate `DeploymentConfig` (or `Deployment`), `Service`, and `Route` resources.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Wait for the build and deployment process to complete. You will see detailed logs from Maven.</pre>
</div>
</div>
</li>
<li>
<p><strong>Verify Deployment</strong></p>
<div class="literalblock">
<div class="content">
<pre>After the Maven command finishes, check the status of your deployment in OpenShift:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```bash
oc get pods -l app.kubernetes.io/name=quarkus-artemis-messaging
oc get route quarkus-artemis-messaging
```
Wait for the application pod to transition to the `Running` state. Then, retrieve the hostname of the generated OpenShift Route for your application:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```bash
export QUARKUS_APP_ROUTE=$(oc get route quarkus-artemis-messaging -o jsonpath='{.spec.host}')
echo "Quarkus application available at: http://$QUARKUS_APP_ROUTE"
```</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_7_test_end_to_end_messaging_on_openshift"><a class="anchor" href="#_step_7_test_end_to_end_messaging_on_openshift"></a>Step 7: Test End-to-End Messaging on OpenShift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that your Quarkus microservice is running on OpenShift, let&#8217;s test the complete messaging flow.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Send Messages via the Deployed Application</strong></p>
<div class="literalblock">
<div class="content">
<pre>Use the `curl` command with the OpenShift Route hostname you just exported to trigger message production:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```bash
curl http://$QUARKUS_APP_ROUTE/prices/send
```
Repeat this command several times to send multiple messages. Each `curl` request will trigger your Quarkus application to send a message to the Artemis broker.</pre>
</div>
</div>
</li>
<li>
<p><strong>Monitor Application Logs</strong></p>
<div class="literalblock">
<div class="content">
<pre>Check the logs of your Quarkus application pod to observe both message production and consumption on OpenShift:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```bash
oc logs -f $(oc get pod -l app.kubernetes.io/name=quarkus-artemis-messaging -o jsonpath='{.items[0].metadata.name}')
```
You should see output similar to this, indicating that your deployed Quarkus microservice is successfully sending messages to the Artemis broker and then receiving them from the same broker:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>```
...
Producer sent price: 103.78912
Consumer received price: 103.79
Producer sent price: 108.12345
Consumer received price: 108.12
...
```
This confirms that your Quarkus microservice is correctly integrated with ActiveMQ Artemis on OpenShift for distributed messaging.</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting_tips"><a class="anchor" href="#_troubleshooting_tips"></a>Troubleshooting Tips</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><strong>Connectivity Issues</strong>:</p>
</li>
<li>
<p><strong>Verify <code>application.properties</code></strong>: Double-check <code>mp.messaging.connector.amqp.host</code>, <code>port</code>, <code>username</code>, <code>password</code>, and <code>use-ssl</code>. A common error is incorrect <code>port</code> (e.g., using 5672 instead of 443 for an HTTPS route) or <code>use-ssl</code> setting (e.g., <code>false</code> when <code>true</code> is needed for a secure route).</p>
</li>
<li>
<p><strong>OpenShift Networking</strong>: Ensure your Quarkus application&#8217;s namespace (<code>my-quarkus-app-project</code>) has network access to the Artemis broker&#8217;s namespace (<code>amq-artemis-project</code>). This typically involves default OpenShift networking policies allowing inter-project communication, but custom network policies could restrict it.</p>
</li>
<li>
<p><strong>Artemis Broker Logs</strong>: Check the logs of your ActiveMQ Artemis broker pods for any connection errors or refused attempts.</p>
</li>
<li>
<p><strong>Route Check</strong>: Verify the Artemis AMQP route is actually up and serving traffic: <code>oc get route artemis-broker-0-amqp -o jsonpath='{.status.ingress[0].host}'</code>.</p>
</li>
<li>
<p><strong>Message Not Sent/Received</strong>:</p>
</li>
<li>
<p><strong>Channel and Address Mismatch</strong>: Ensure the channel names (<code>prices-out</code>, <code>prices-in</code>) in your Java code (<code>@Channel</code>, <code>@Incoming</code>) match the <code>application.properties</code> configuration (<code>mp.messaging.outgoing.prices-out</code>, <code>mp.messaging.incoming.prices-in</code>). Also, confirm the <code>address</code> (<code>prices</code>) is consistent.</p>
</li>
<li>
<p><strong>Artemis Console</strong>: Access the ActiveMQ Artemis Hawtio console (if deployed) to inspect queues/topics. Check if messages are arriving in the <code>prices</code> queue (from producer) and being consumed (decreasing message count).</p>
</li>
<li>
<p><strong>Consumer Acknowledgment</strong>: If messages are stuck in the queue, verify <code>mp.messaging.incoming.prices-in.auto-acknowledgement=false</code> and <code>@Acknowledgment(Acknowledgment.Strategy.POST_COMMIT)</code> are correctly implemented.</p>
</li>
<li>
<p><strong>Deployment Errors</strong>:</p>
</li>
<li>
<p><strong>Maven Output</strong>: Carefully review the <code>mvn clean package</code> output for any errors during image build or OpenShift resource creation.</p>
</li>
<li>
<p><strong>OpenShift Events</strong>: Use <code>oc describe deployment/quarkus-artemis-messaging</code> and <code>oc describe pod/&lt;pod-name&gt;</code> to check for OpenShift events that might indicate why a pod isn&#8217;t starting (e.g., image pull errors, insufficient resources, failed liveness/readiness probes).</p>
</li>
<li>
<p><strong>Image Stream</strong>: Verify the image stream was created and the image was pushed: <code>oc get is quarkus-artemis-messaging</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clean_up_optional"><a class="anchor" href="#_clean_up_optional"></a>Clean Up (Optional)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To remove the resources created in this lab from your OpenShift cluster:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Delete the Quarkus application deployment:</strong>
<code><code>bash
oc project my-quarkus-app-project # Switch to your application project
oc delete all -l app.kubernetes.io/name=quarkus-artemis-messaging
</code></code></p>
</li>
<li>
<p><strong>Delete the Quarkus application project:</strong>
<code><code>bash
oc delete project my-quarkus-app-project
</code></code></p>
</li>
<li>
<p><strong>Delete the Artemis cluster</strong> (if you are completely finished with it and wish to clean up, refer to the "Hands-on Lab: Deploying a highly available ActiveMQ Artemis cluster on OpenShift" for cleanup instructions).</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion"><a class="anchor" href="#_conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this hands-on lab, you successfully developed a Quarkus microservice capable of robust, distributed messaging with an ActiveMQ Artemis cluster deployed on OpenShift. You gained practical experience in:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Setting up a Quarkus project with Reactive Messaging extensions.</p>
</li>
<li>
<p>Configuring secure AMQP connectivity to Artemis on OpenShift.</p>
</li>
<li>
<p>Implementing both message producers and consumers using SmallRye Reactive Messaging annotations.</p>
</li>
<li>
<p>Understanding and configuring message acknowledgment strategies for reliability.</p>
</li>
<li>
<p>Seamlessly deploying your Quarkus application to OpenShift using its native integration capabilities.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This foundational understanding of Quarkus and ActiveMQ Artemis integration is key to building highly scalable, resilient, and reactive microservice architectures.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="deploying-quarkus-messaging-applications-on-openshift.html">Deploying Quarkus messaging applications on OpenShift</a></span>
  <span class="next"><a href="../spring-boot-example/spring-boot-example.html">Spring Boot Example</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
