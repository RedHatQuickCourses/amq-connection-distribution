<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Implementing message consumers in Quarkus :: Understanding and Implementing Message Oriented Middleware</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Understanding and Implementing Message Oriented Middleware</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="amq-connection-distribution" data-version="1.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Understanding and Implementing Message Oriented Middleware</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../introduction-to-message-oriented-middleware-mom/introduction-to-message-oriented-middleware-mom.html">Introduction to Message Oriented Middleware (MOM)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction-to-message-oriented-middleware-mom/what-is-message-oriented-middleware.html">What is Message Oriented Middleware?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction-to-message-oriented-middleware-mom/core-concepts-messages-producers-consumers-brokers.html">Core concepts: Messages, Producers, Consumers, Brokers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction-to-message-oriented-middleware-mom/benefits-of-mom-in-distributed-systems.html">Benefits of MOM in distributed systems</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction-to-message-oriented-middleware-mom/common-use-cases-for-mom.html">Common use cases for MOM</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../challenges-in-distributed-systems/challenges-in-distributed-systems.html">Challenges in Distributed Systems</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../challenges-in-distributed-systems/issues-with-direct-service-to-service-communication.html">Issues with direct service-to-service communication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../challenges-in-distributed-systems/the-need-for-asynchronous-processing.html">The need for asynchronous processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../challenges-in-distributed-systems/problems-with-reliability-and-data-consistency.html">Problems with reliability and data consistency</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../challenges-in-distributed-systems/scalability-and-coupling-concerns.html">Scalability and coupling concerns</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../mom-solutions-for-distributed-systems/mom-solutions-for-distributed-systems.html">MOM Solutions for Distributed Systems</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../mom-solutions-for-distributed-systems/decoupling-services-with-message-queues.html">Decoupling services with message queues</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../mom-solutions-for-distributed-systems/point-to-point-ptp-messaging-model.html">Point-to-Point (PTP) messaging model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../mom-solutions-for-distributed-systems/publishsubscribe-pubsub-messaging-model.html">Publish/Subscribe (Pub/Sub) messaging model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../mom-solutions-for-distributed-systems/ensuring-message-delivery-and-reliability.html">Ensuring message delivery and reliability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../mom-solutions-for-distributed-systems/message-persistence-and-durability.html">Message persistence and durability</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../hands-on-lab-implementing-messaging-patterns/hands-on-lab-implementing-messaging-patterns.html">Hands-on Lab: Implementing Messaging Patterns</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hands-on-lab-implementing-messaging-patterns/setting-up-a-basic-message-broker.html">Setting up a basic message broker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hands-on-lab-implementing-messaging-patterns/developing-a-producer-for-point-to-point-messaging.html">Developing a producer for Point-to-Point messaging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hands-on-lab-implementing-messaging-patterns/developing-a-consumer-for-point-to-point-messaging.html">Developing a consumer for Point-to-Point messaging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hands-on-lab-implementing-messaging-patterns/implementing-a-publisher-for-publishsubscribe.html">Implementing a publisher for Publish/Subscribe</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hands-on-lab-implementing-messaging-patterns/implementing-a-subscriber-for-publishsubscribe.html">Implementing a subscriber for Publish/Subscribe</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Understanding and Implementing Message Oriented Middleware</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Understanding and Implementing Message Oriented Middleware</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Understanding and Implementing Message Oriented Middleware</a></li>
    <li><a href="implementing-message-consumers-in-quarkus.html">Implementing message consumers in Quarkus</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Implementing message consumers in Quarkus</h1>
<h1 id="_implementing_message_consumers_in_quarkus" class="sect0"><a class="anchor" href="#_implementing_message_consumers_in_quarkus"></a>Implementing Message Consumers in Quarkus</h1>
<div class="paragraph">
<p>Understanding how to consume messages is crucial for building resilient and reactive microservices. Quarkus provides powerful and efficient mechanisms for implementing message consumers, primarily through its integration with MicroProfile Reactive Messaging. This section details how to create message consumers in Quarkus to process messages from an ActiveMQ Artemis broker, ensuring messages are handled reliably and efficiently.</p>
</div>
<div class="sect1">
<h2 id="_reactive_messaging_in_quarkus"><a class="anchor" href="#_reactive_messaging_in_quarkus"></a>Reactive Messaging in Quarkus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus leverages the MicroProfile Reactive Messaging specification, which simplifies the development of event-driven applications. It allows developers to define message consumers using annotations, abstracting away much of the underlying messaging infrastructure complexities. This approach promotes a non-blocking, asynchronous style of programming, which is ideal for high-throughput messaging scenarios.</p>
</div>
<div class="sect2">
<h3 id="_core_concepts_for_consumers"><a class="anchor" href="#_core_concepts_for_consumers"></a>Core Concepts for Consumers</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>@Incoming</code> Annotation:
This annotation marks a method as a message consumer. The value specified in the annotation refers to a logical channel name, which is then mapped to an an external messaging broker (like ActiveMQ Artemis queue or topic) via configuration in <code>application.properties</code>.</p>
</li>
<li>
<p>Message Payloads:
A consumer method can receive the message payload directly (e.g., <code>String</code>, <code>Integer</code>, a custom POJO), or it can receive a <code>org.eclipse.microprofile.reactive.messaging.Message</code> wrapper. The <code>Message</code> wrapper provides additional metadata (like headers) and fine-grained control over message acknowledgment.</p>
</li>
<li>
<p>Acknowledgment:
Reactive Messaging supports different acknowledgment strategies to ensure message processing guarantees:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Automatic Acknowledgment</strong>: By default, if a consumer method returns <code>void</code>, <code>CompletionStage&lt;Void&gt;</code>, or any non-<code>Message</code> type, the message is automatically acknowledged upon successful completion of the method. This is suitable for "fire-and-forget" or simple processing tasks.</p>
</li>
<li>
<p><strong>Manual Acknowledgment</strong>: If a consumer method receives a <code>Message&lt;T&gt;</code> object, it can manually acknowledge the message using <code>message.ack()</code>. This gives finer control over when a message is considered processed, typically after all business logic and persistence operations are successfully completed.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Error Handling:
If a consumer method throws an exception, the message is typically <strong>nacked</strong> (negative acknowledgment), and the messaging system&#8217;s redelivery policies come into play. For ActiveMQ Artemis, this usually means the message is redelivered to the same consumer or another consumer in the group, or routed to a Dead Letter Queue (DLQ) after a configured number of retries. Specific error handling logic can be implemented within the consumer method using <code>try-catch</code> blocks, or by configuring error strategies at the channel level.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_a_simple_message_consumer"><a class="anchor" href="#_implementing_a_simple_message_consumer"></a>Implementing a Simple Message Consumer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s walk through an example of implementing a message consumer that listens to a queue on ActiveMQ Artemis and processes incoming messages.</p>
</div>
<div class="sect2">
<h3 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h3>
<div class="paragraph">
<p>Ensure you have a Quarkus project set up. You will need to add the necessary dependencies for Reactive Messaging and the AMQP connector for ActiveMQ Artemis.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml dependencies</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-smallrye-reactive-messaging-amqp&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-arc&lt;/artifactId&gt; &lt;!-- CDI for @ApplicationScoped --&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_consumer_class_example"><a class="anchor" href="#_consumer_class_example"></a>Consumer Class Example</h3>
<div class="paragraph">
<p>Create a simple CDI bean that will contain our consumer methods. We&#8217;ll demonstrate both automatic and manual acknowledgment patterns.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/acme/messaging/ArtemisConsumer.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.messaging;

import jakarta.enterprise.context.ApplicationScoped;
import org.eclipse.microprofile.reactive.messaging.Incoming;
import org.eclipse.microprofile.reactive.messaging.Message; // For manual acknowledgment
import org.eclipse.microprofile.reactive.messaging.Metadata; // For accessing message metadata
import org.jboss.logging.Logger;

@ApplicationScoped
public class ArtemisConsumer {

    private static final Logger LOG = Logger.getLogger(ArtemisConsumer.class);

    /**
     * Consumes messages from the 'price-updates' channel.
     * Uses automatic acknowledgment as the method returns void.
     * The payload is directly injected.
     *
     * @param price The price value from the message payload.
     */
    @Incoming("price-updates")
    public void consumePriceUpdate(double price) {
        LOG.infof("Received price update: %.2f", price);
        // Simulate processing, e.g., storing in a database or performing calculations.
        // If an exception occurs here, the message will be nacked and potentially redelivered.
    }

    /**
     * Consumes messages from the 'order-requests' channel.
     * Uses manual acknowledgment, demonstrating more control over when a message is acknowledged.
     * The full Message object is injected, allowing access to payload and metadata.
     *
     * @param incomingMessage The incoming Message object containing the order details.
     */
    @Incoming("order-requests")
    public void processOrderRequest(Message&lt;String&gt; incomingMessage) {
        String orderDetails = incomingMessage.getPayload();
        // Accessing metadata if available (e.g., from a producer)
        incomingMessage.getMetadata(Metadata.class)
                       .ifPresent(metadata -&gt; LOG.debugf("Message metadata: %s", metadata));

        LOG.infof("Processing order request: %s", orderDetails);

        try {
            // Simulate complex business logic and potential failures
            if (orderDetails.contains("urgent") &amp;&amp; Math.random() &lt; 0.3) {
                // Simulate a transient error for urgent orders
                throw new RuntimeException("Simulated transient failure for urgent order: " + orderDetails);
            }

            // If processing is successful, acknowledge the message
            incomingMessage.ack().toCompletableFuture().join();
            LOG.infof("Order request successfully processed and acknowledged: %s", orderDetails);

        } catch (Exception e) {
            LOG.errorf("Error processing order request '%s': %s. Message will be nacked.", orderDetails, e.getMessage());
            // If an error occurs, negatively acknowledge the message.
            // This tells the broker to redeliver or move to DLQ based on broker configuration.
            incomingMessage.nack(e).toCompletableFuture().join();
        }
    }

    /**
     * Consumes messages from a topic with shared subscription semantics.
     * This consumer is part of a consumer group 'inventory-group'.
     * Messages sent to 'inventory-topic' will be distributed among consumers in 'inventory-group'.
     *
     * @param itemUpdate The item update details.
     */
    @Incoming("inventory-topic")
    public void handleInventoryUpdate(String itemUpdate) {
        LOG.infof("Inventory service received item update: %s", itemUpdate);
        // Process inventory update, e.g., update stock levels.
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_for_activemq_artemis"><a class="anchor" href="#_configuration_for_activemq_artemis"></a>Configuration for ActiveMQ Artemis</h3>
<div class="paragraph">
<p>The channels defined in the <code>@Incoming</code> annotations need to be mapped to physical queues or topics on your ActiveMQ Artemis broker. This is done in the <code>src/main/resources/application.properties</code> file.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Quarkus application name
quarkus.application.name=quarkus-artemis-consumer-app

# ActiveMQ Artemis Broker connection details for the default 'amqp' connector
# Replace with your Artemis service host and port
mp.messaging.connector.amqp.host=localhost
mp.messaging.connector.amqp.port=5672
mp.messaging.connector.amqp.username=artemis
mp.messaging.connector.amqp.password=artemis
mp.messaging.connector.amqp.client-id=quarkus-artemis-consumer-client
mp.messaging.connector.amqp.connection-reconnect-attempts=-1 # Reconnect indefinitely on connection loss
mp.messaging.connector.amqp.connection-timeout=30s

# --- Configuration for 'price-updates' channel (Automatic Acknowledgment) ---
mp.messaging.incoming.price-updates.connector=amqp
mp.messaging.incoming.price-updates.queue=price-queue
mp.messaging.incoming.price-updates.durable=true             # Messages are durable by default for queues
mp.messaging.incoming.price-updates.max-unacked-messages=100 # Max messages in flight before flow control
mp.messaging.incoming.price-updates.credit-window=100        # Credit window for flow control (AMQP)
mp.messaging.incoming.price-updates.acknowledgement=post-commit # Default for automatic acknowledgment

# --- Configuration for 'order-requests' channel (Manual Acknowledgment) ---
mp.messaging.incoming.order-requests.connector=amqp
mp.messaging.incoming.order-requests.queue=order-queue
mp.messaging.incoming.order-requests.acknowledgement=manual # Explicitly set to manual

# --- Configuration for 'inventory-topic' channel (Shared Subscription) ---
mp.messaging.incoming.inventory-topic.connector=amqp
mp.messaging.incoming.inventory-topic.topic=inventory-topic   # Connect to a topic
mp.messaging.incoming.inventory-topic.broadcast=false         # Important for shared subscription
mp.messaging.incoming.inventory-topic.groups=inventory-group  # Define a consumer group for shared subscription
mp.messaging.incoming.inventory-topic.durable=true            # For durable shared subscriptions</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_explanation_of_configuration_properties"><a class="anchor" href="#_explanation_of_configuration_properties"></a>Explanation of Configuration Properties</h3>
<div class="ulist">
<ul>
<li>
<p><code>mp.messaging.connector.amqp.*</code>: These properties define the global connection parameters for the AMQP connector to your ActiveMQ Artemis broker.</p>
</li>
<li>
<p><code>host</code>, <code>port</code>, <code>username</code>, <code>password</code>: Essential for broker connectivity.</p>
</li>
<li>
<p><code>client-id</code>: A unique identifier for this client, important for durable subscriptions.</p>
</li>
<li>
<p><code>connection-reconnect-attempts</code>: Configures the number of reconnection attempts. <code>-1</code> means unlimited attempts.</p>
</li>
<li>
<p><code>mp.messaging.incoming.&lt;channel-name&gt;.connector=amqp</code>: Specifies that the channel uses the AMQP connector configured above.</p>
</li>
<li>
<p><code>mp.messaging.incoming.&lt;channel-name&gt;.queue</code>: The name of the queue on the ActiveMQ Artemis broker from which messages will be consumed. Use this for point-to-point messaging.</p>
</li>
<li>
<p><code>mp.messaging.incoming.&lt;channel-name&gt;.topic</code>: The name of the topic on the ActiveMQ Artemis broker from which messages will be consumed. Use this for publish-subscribe messaging.</p>
</li>
<li>
<p><code>mp.messaging.incoming.&lt;channel-name&gt;.durable</code>: (Optional) Whether the subscription should be durable. For topics, <code>true</code> ensures that messages are retained for a consumer even if it&#8217;s temporarily offline. For queues, messages are durable by nature.</p>
</li>
<li>
<p><code>mp.messaging.incoming.&lt;channel-name&gt;.max-unacked-messages</code>: (Optional, AMQP specific) The maximum number of unacknowledged messages that the consumer can have outstanding. This helps in flow control, preventing the consumer from being overwhelmed.</p>
</li>
<li>
<p><code>mp.messaging.incoming.&lt;channel-name&gt;.credit-window</code>: (Optional, AMQP specific) Part of AMQP flow control, determining how many credits the consumer grants to the broker.</p>
</li>
<li>
<p><code>mp.messaging.incoming.&lt;channel-name&gt;.acknowledgement</code>: Sets the acknowledgment strategy.</p>
</li>
<li>
<p><code>post-commit</code>: (Default) Message is acknowledged after the consumer method successfully completes.</p>
</li>
<li>
<p><code>manual</code>: Requires explicit <code>message.ack()</code> or <code>message.nack()</code>.</p>
</li>
<li>
<p><code>mp.messaging.incoming.&lt;channel-name&gt;.broadcast=false</code>: For topic subscriptions, setting this to <code>false</code> (the default for queues) combined with <code>groups</code> enables shared subscription semantics.</p>
</li>
<li>
<p><code>mp.messaging.incoming.&lt;channel-name&gt;.groups</code>: (Optional) Defines a consumer group. When multiple consumers subscribe to the same topic/queue with the same group name, messages are distributed among them (shared subscription), ensuring each message is processed only once by the group. This is crucial for load balancing messages across instances of your consuming application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By leveraging these configurations and the <code>@Incoming</code> annotation, Quarkus developers can efficiently implement robust and scalable message consumers that seamlessly integrate with ActiveMQ Artemis, handling various messaging patterns and ensuring message reliability.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
