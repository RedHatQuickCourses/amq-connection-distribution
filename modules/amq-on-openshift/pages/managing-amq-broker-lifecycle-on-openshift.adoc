#  Managing AMQ Broker lifecycle on OpenShift

[id="managing-amq-broker-lifecycle-openshift"]
= Managing AMQ Broker Lifecycle on OpenShift

Understanding the lifecycle management of Red Hat AMQ Broker on OpenShift is crucial for maintaining robust and highly available messaging infrastructure. The AMQ Broker Operator simplifies these complex operations by automating deployment, scaling, upgrades, and more, all through the declarative power of Custom Resources (CRs).

== The Role of the AMQ Broker Operator in Lifecycle Management

The Red Hat AMQ Broker Operator on OpenShift extends the Kubernetes API, providing a declarative way to create, configure, and manage AMQ Broker instances. Instead of manually interacting with `oc` commands for individual OpenShift resources like Pods, Deployments, and Services, you interact with an `ActiveMQArtemis` custom resource. The Operator continuously observes the desired state defined in this CR and works to bring the actual state of your AMQ Broker deployment into alignment. This active reconciliation is the core of its lifecycle management capabilities.

=== Deployment and Provisioning
As introduced in previous sections, the initial deployment of an AMQ Broker instance is triggered by creating an `ActiveMQArtemis` Custom Resource (CR). The Operator takes this CR as its blueprint and translates it into the necessary underlying OpenShift resources (e.g., StatefulSets for stateful applications, Services for network access, Routes for external connectivity, ConfigMaps for configuration, and Persistent Volume Claims for storage) to provision a running broker. This declarative approach forms the foundation of all subsequent lifecycle operations.

=== Scaling AMQ Broker Instances
One of the most significant benefits of using the Operator is its ability to scale broker instances seamlessly. You can scale horizontally by simply modifying the `spec.deploymentPlan.size` field within your `ActiveMQArtemis` CR. The Operator detects this change and intelligently provisions or de-provisions broker pods to match the desired count. For clustered deployments, the Operator also ensures that new instances are correctly integrated into the cluster and that existing instances are gracefully removed during scale-down operations, preserving data integrity.

=== Upgrading AMQ Broker Versions
The Operator facilitates non-disruptive upgrades of AMQ Broker instances. When the `spec.deploymentPlan.image` field in the `ActiveMQArtemis` CR is updated to specify a newer broker image, or when a new version of the AMQ Broker Operator is deployed that manages a different default broker version, the Operator intelligently orchestrates the upgrade process. This typically involves a rolling upgrade strategy, ensuring minimal downtime. The Operator handles:

*   Pulling the new container images.
*   Updating configuration files if necessary.
*   Managing the rollout of new pods, ensuring that old pods are only terminated after new ones are ready and integrated (especially crucial for clustered brokers).

=== Self-Healing and High Availability
The AMQ Broker Operator inherently contributes to the high availability of your messaging infrastructure. If a broker pod crashes, becomes unresponsive, or is evicted by OpenShift, the Operator detects this deviation from the desired state (as defined in the CR) and automatically takes steps to remediate the issue. This might involve restarting the problematic pod or provisioning a completely new one. For clustered deployments, it also works to ensure that quorum is maintained and message replication continues uninterrupted, even in the face of individual broker failures.

=== Monitoring and Observability
While dedicated monitoring solutions (like Prometheus and Grafana) are commonly integrated, the Operator itself often exposes standard Kubernetes metrics about the health and performance of the broker instances. This helps in proactive lifecycle management by providing insights into broker operational status, resource utilization, and potential issues before they impact services.

=== Decommissioning and Deletion
When an AMQ Broker instance is no longer needed, it can be gracefully decommissioned by simply deleting its `ActiveMQArtemis` CR. The Operator takes responsibility for cleaning up all associated OpenShift resources that it previously created, including pods, services, routes, ConfigMaps, and optionally, persistent volume claims. This ensures that no orphaned resources are left behind in your OpenShift project, maintaining a clean and manageable environment.

== Hands-on Lab: Managing AMQ Broker Lifecycle

This lab will guide you through practical aspects of managing an AMQ Broker's lifecycle on OpenShift, specifically focusing on scaling and graceful deletion using the Operator.

=== Prerequisites

*   An OpenShift cluster with the Red Hat AMQ Broker Operator installed and running in your target project.
*   An existing `ActiveMQArtemis` instance deployed in your project. If you don't have one, please refer to the "Deploying AMQ Broker instances using the Operator" section of this course content.
*   The `oc` command-line interface (CLI) tool configured and logged in to your OpenShift cluster.
*   A dedicated OpenShift project (namespace) for your AMQ Broker instances, for example, `amq-broker-project`. We'll use `my-broker` as the name for the broker instance in this lab.

=== Step 1: Verify Current Broker Instance

First, let's inspect the currently deployed AMQ Broker instance and its number of replicas.

. Log in to your OpenShift cluster if you haven't already:
+
[source,bash]
----
oc login -u <username> -p <password> <openshift_api_url>
----

. Switch to your project where the AMQ Broker is deployed:
+
[source,bash]
----
oc project amq-broker-project
----

. Get the details of your `ActiveMQArtemis` custom resource. Replace `my-broker` with the actual name of your broker instance if it differs:
+
[source,bash]
----
oc get activemqartemises.broker.amq.io my-broker -o yaml
----
+
Look for the `spec.deploymentPlan.size` field in the output to confirm the current number of replicas.

. Verify the running pods associated with your broker instance:
+
[source,bash]
----
oc get pods -l app=my-broker
----
+
You should see pods listed corresponding to the `size` specified in the CR (e.g., `my-broker-ss-0`).

=== Step 2: Scale Up the AMQ Broker Instance

Now, let's scale up your broker instance by modifying the `ActiveMQArtemis` custom resource.

. Edit the `ActiveMQArtemis` custom resource directly:
+
[source,bash]
----
oc edit activemqartemises.broker.amq.io my-broker
----

. In the editor, locate the `spec.deploymentPlan.size` field and change its value from its current number (e.g., `1`) to `2`.
+
[source,yaml]
----
apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-broker
  # ...
spec:
  deploymentPlan:
    size: 2 # <1>
    image: registry.redhat.io/amq7/amq-broker-rhel8:latest
    # ... other configurations
----
<1> Change this value to `2` to scale up.

. Save and exit the editor. The AMQ Broker Operator will detect this change and immediately begin provisioning a new broker pod.

. Monitor the pods to observe the new instance being created and reach a ready state:
+
[source,bash]
----
oc get pods -l app=my-broker -w
----
+
You should see a new pod (e.g., `my-broker-ss-1`) starting and eventually reaching `Running` status. Press `Ctrl+C` to exit the watch command once both pods are running.

=== Step 3: Scale Down the AMQ Broker Instance

Let's scale the broker instance back down to its original size.

. Edit the `ActiveMQArtemis` custom resource once more:
+
[source,bash]
----
oc edit activemqartemises.broker.amq.io my-broker
----

. Change `spec.deploymentPlan.size` back to `1`.

. Save and exit. The Operator will now gracefully terminate one of the broker pods.

. Monitor the pods to see one of them being terminated:
+
[source,bash]
----
oc get pods -l app=my-broker -w
----
+
You should see one of the pods (e.g., `my-broker-ss-1`) entering `Terminating` state and eventually disappearing from the list.

=== Step 4: Delete the AMQ Broker Instance

Finally, we will gracefully delete the entire AMQ Broker instance and all its associated resources.

. Delete the `ActiveMQArtemis` custom resource:
+
[source,bash]
----
oc delete activemqartemises.broker.amq.io my-broker
----
+
You will be prompted to confirm the deletion. Type `y` and press Enter.

. Monitor the deletion of associated resources, particularly the remaining broker pod:
+
[source,bash]
----
oc get pods -l app=my-broker -w
----
+
The last remaining pod (`my-broker-ss-0`) will go into a `Terminating` state and eventually disappear.

. Verify that all resources created by the Operator for this broker instance are cleaned up:
+
[source,bash]
----
oc get all -l app=my-broker
----
+
This command should return "No resources found in <your-project-name> namespace." or similar, indicating that the Operator has successfully cleaned up all associated components.