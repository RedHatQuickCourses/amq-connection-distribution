#  Deploying AMQ Broker instances using the Operator

= Deploying AMQ Broker Instances using the Operator

_Deploying Red Hat AMQ Broker on OpenShift involves leveraging the powerful capabilities of the AMQ Broker Operator. This approach simplifies the complex orchestration tasks, automates the lifecycle management, and ensures that your messaging infrastructure runs reliably and efficiently within the OpenShift ecosystem._

== The AMQ Broker Operator: Simplifying Deployment

The **Red Hat AMQ Broker Operator** is a Kubernetes-native application that extends the functionality of OpenShift, automating the deployment, scaling, and management of AMQ Broker instances. Built upon the Operator Framework, it embodies operational knowledge specific to AMQ Broker, transforming manual tasks into automated, repeatable processes.

Think of the Operator as a "robot administrator" for AMQ Broker. Instead of you manually creating Kubernetes Deployments, StatefulSets, Services, and Routes, the Operator understands the desired state of an AMQ Broker instance through a high-level configuration. It then takes care of all the underlying OpenShift resources needed to achieve and maintain that state.

=== Why use the AMQ Broker Operator for Deployment?

Deploying AMQ Broker with the Operator offers significant advantages:

*   **Declarative Management**: You define *what* you want (e.g., "I want an AMQ Broker with 3 pods and persistence enabled") using a Custom Resource (CR), and the Operator ensures that state is met and maintained.
*   **Automation of Complex Tasks**: The Operator automates common operational tasks such as:
    *   Initial deployment and configuration.
    *   Scaling up or down the number of broker pods.
    *   Handling upgrades and patching.
    *   Managing persistent storage.
    *   Configuring networking (services, routes).
    *   Implementing high availability (HA) and disaster recovery.
*   **Reduced Operational Overhead**: By automating routine tasks, the Operator frees up administrators to focus on higher-value activities, reducing the time and effort required to manage AMQ Broker deployments.
*   **Consistency and Reliability**: Automating deployments minimizes human error, leading to more consistent and reliable AMQ Broker instances.
*   **Kubernetes-Native Integration**: It leverages OpenShift's core features like namespaces, role-based access control (RBAC), and persistent storage, making AMQ Broker a first-class citizen in your container platform.

=== How the Operator Deploys AMQ Broker Instances

The core mechanism for interacting with the AMQ Broker Operator is through **Custom Resources (CRs)**. When the Operator is installed, it registers a new API type with OpenShift, typically `ActiveMQArtemis` (or `activemqartemises.broker.amq.redhat.com`).

To deploy an AMQ Broker instance:

1.  You create a YAML file that describes your desired AMQ Broker instance using the `ActiveMQArtemis` Custom Resource Definition (CRD). This YAML specifies parameters like the number of broker pods, persistence settings, security configurations, and more.
2.  You apply this YAML file to your OpenShift cluster using `oc apply -f <your-cr.yaml>`.
3.  The AMQ Broker Operator, which is constantly watching for `ActiveMQArtemis` CRs, detects the new resource.
4.  The Operator then translates your high-level request into the necessary low-level OpenShift resources (e.g., a `StatefulSet` for broker pods, `Service` objects for network access, `PersistentVolumeClaims` for storage, `Route` for external access, etc.).
5.  It continuously monitors these resources and the actual state of the AMQ Broker instance to ensure it matches the desired state defined in your CR. If a pod fails or a configuration drifts, the Operator works to reconcile the state.

This declarative approach makes managing complex applications like AMQ Broker much simpler and more robust on OpenShift.

== Hands-on Lab: Deploying a Basic AMQ Broker Instance

In this lab, you will deploy a single-node AMQ Broker instance using the AMQ Broker Operator on OpenShift.

=== Prerequisites

Before you begin, ensure you have:

*   Access to an OpenShift cluster (version 4.x or later).
*   The `oc` command-line interface (CLI) installed and configured to connect to your OpenShift cluster.
*   The AMQ Broker Operator installed in your OpenShift cluster. If not installed, typically an administrator would install it from the OpenShift Container Platform console (OperatorHub). It usually resides in the `openshift-operators` namespace or a dedicated namespace like `amq-broker-operator`.

=== Lab Steps

==== 1. Log in to your OpenShift Cluster

Ensure you are logged in to your OpenShift cluster with sufficient permissions to create projects and deploy applications.

[source,bash]
----
oc login --token=<your_token> --server=<your_api_url>
----

==== 2. Create a New OpenShift Project

Create a dedicated project (namespace) for your AMQ Broker instance. This helps organize your resources.

[source,bash]
----
oc new-project amq-broker-demo
----

You should now be in the `amq-broker-demo` project. Verify with:

[source,bash]
----
oc project
----

==== 3. Create the Custom Resource (CR) for AMQ Broker

Now, create a YAML file that defines your AMQ Broker instance. For a basic deployment, we'll create a single-node broker with persistence enabled.

Create a file named `amq-broker-instance.yaml` with the following content:

[source,yaml]
----
apiVersion: broker.amq.redhat.com/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-broker
spec:
  deploymentPlan:
    size: 1 # Number of broker pods
    persistenceEnabled: true # Enable message persistence
    journalStorageClassName: gp2 # Use a storage class provided by OpenShift (e.g., 'gp2' for AWS, 'standard' for others)
    journalVolumeRequest: 2Gi # Request 2 GiB for the journal volume
    image: registry.redhat.io/amq7/amq-broker-rhel8:7.11 # Specify the broker image
  console:
    expose: true # Expose the Hawtio console
  acceptors:
    - name: amqp
      protocols: AMQP
      port: 5672
    - name: mqtt
      protocols: MQTT
      port: 1883
    - name: openwire
      protocols: OPENWIRE
      port: 61616
    - name: core
      protocols: CORE
      port: 61617
    - name: stomp
      protocols: STOMP
      port: 61613
  metrics:
    expose: true # Expose metrics for Prometheus
----

[[_note_storageclass]]
.Note on Storage Class
The `journalStorageClassName` value (`gp2` in this example) depends on your OpenShift cluster's underlying infrastructure. Common values include `standard`, `thin`, `ocs-storagecluster-cephfs`, or cloud-specific ones like `gp2` (AWS), `azurefile` (Azure), `gce-pd` (GCP). If `gp2` doesn't work, consult your OpenShift administrator or `oc get storageclass` to find available options. For a non-persistent broker (not recommended for production), you could set `persistenceEnabled: false`.

==== 4. Apply the Custom Resource

Deploy the AMQ Broker instance by applying the `amq-broker-instance.yaml` file to your OpenShift cluster:

[source,bash]
----
oc apply -f amq-broker-instance.yaml
----

You should see output similar to:

```
activemqartemis.broker.amq.redhat.com/my-broker created
```

==== 5. Verify the Deployment

The Operator will now start creating the necessary OpenShift resources. This might take a few minutes.

a.  **Check the `ActiveMQArtemis` CR status:**

    [source,bash]
    ----
    oc get activemqartemises my-broker -o yaml
    ----

    Look for the `status` section. It should eventually show `Ready: true`.

b.  **Check the Pods:**

    [source,bash]
    ----
    oc get pods -w
    ----

    You should see a pod starting with `my-broker-ss-0` eventually reach a `Running` state:

    ```
    NAME               READY   STATUS    RESTARTS   AGE
    my-broker-ss-0     1/1     Running   0          2m
    ```
    The `-w` flag will watch for changes, so you can see the pod's status update in real-time. Press `Ctrl+C` to exit the watch.

c.  **Check other resources:**

    The Operator automatically creates a `StatefulSet`, `Service`, `PersistentVolumeClaim` (if persistence is enabled), and potentially `Route` resources.

    *   **StatefulSet:**
        [source,bash]
        ----
        oc get statefulset
        ----
    *   **Services:**
        [source,bash]
        ----
        oc get svc
        ----
    *   **PersistentVolumeClaims:**
        [source,bash]
        ----
        oc get pvc
        ----

==== 6. Access the AMQ Broker Console (Optional)

Since we set `console.expose: true` in our CR, the Operator will create an OpenShift Route to expose the Hawtio-based AMQ Broker console.

a.  **Get the console URL:**

    [source,bash]
    ----
    oc get route my-broker-console -o jsonpath='{.spec.host}'
    ----

    This command will output the URL for the AMQ Broker console.

b.  **Open the URL in your browser.**

    You should be able to access the Hawtio console, which provides a web interface to monitor and manage your AMQ Broker. You'll need to log in. By default, the operator might provision a temporary user or rely on OpenShift's default authentication mechanisms if configured. For simple deployments, the default user `amq` with password `amq` might be enabled, but this is highly insecure for production environments. More robust security configurations will be covered in a later section.

Congratulations! You have successfully deployed a Red Hat AMQ Broker instance on OpenShift using the AMQ Broker Operator. This foundational step is key to building robust messaging solutions within your containerized environment.