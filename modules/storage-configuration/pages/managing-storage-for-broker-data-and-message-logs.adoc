#  Managing storage for broker data and message logs

This module delves into the critical aspect of managing storage for Red Hat AMQ Broker within an OpenShift environment, ensuring data durability and operational reliability.

:page-layout: course
:!toc:

[[storage-configuration]]
= Managing Storage for Broker Data and Message Logs

[[intro-storage-management]]
== Introduction to AMQ Broker Storage on OpenShift

Reliable message delivery and transaction integrity are paramount for enterprise messaging systems. Red Hat AMQ Broker achieves this through robust persistence mechanisms, primarily by writing message data and operational logs to disk. In a containerized environment like OpenShift, managing this persistence requires understanding how AMQ Broker interacts with the underlying storage infrastructure provided by Kubernetes. This section covers the foundational concepts of message persistence in AMQ Broker and how it integrates with OpenShift's Persistent Volumes (PVs) and Persistent Volume Claims (PVCs) to ensure data durability.

[[why-persistence]]
=== Understanding Message Persistence and Journaling

At its core, Red Hat AMQ Broker relies on a journaling mechanism to ensure message persistence. This mechanism guarantees that messages are not lost even if the broker instance crashes or is restarted.

*   **Journal Files**: The broker primarily uses journal files (often called the "journal") to record all persistent operations. This includes adding messages, acknowledging messages, transactions, and other critical state changes. The journal is typically an append-only log, optimized for high write throughput. Before an operation is considered complete and acknowledged to a client, it must be written to the journal.
*   **Data Directories**: While the journal files store the operational log, the actual message payloads and other broker state information are stored in designated data directories. The exact structure and content within these directories depend on the broker's configuration and whether large messages are being handled.
*   **Durability and Reliability**: By persisting data to disk, AMQ Broker provides durability. If a broker pod fails, restarts, or is migrated to another node, the persistent messages and its state can be recovered from the stored journal and data files when a new pod starts and attaches to the same storage. This is fundamental for building reliable, fault-tolerant messaging solutions.

[[openshift-persistence-integration]]
=== Integrating with OpenShift Persistent Volumes (PVs) and Persistent Volume Claims (PVCs)

OpenShift, being a Kubernetes distribution, abstracts storage resources through Persistent Volumes (PVs) and Persistent Volume Claims (PVCs). This abstraction allows applications like AMQ Broker to request storage without needing to know the specifics of the underlying storage infrastructure.

*   **Persistent Volumes (PVs)**: A PV is a cluster-scoped resource that represents a piece of storage in the cluster. It can be provisioned statically by a cluster administrator or dynamically by a StorageClass. PVs have specific capacities (e.g., 10Gi), access modes (e.g., `ReadWriteOnce`, `ReadWriteMany`), and reclaim policies.
*   **Persistent Volume Claims (PVCs)**: A PVC is a request for storage by a user or application. It specifies the desired size, access mode, and optionally a StorageClass. When a pod is deployed, it requests a PVC, and Kubernetes binds that PVC to an available PV that meets its requirements.
*   **Storage Classes**: A StorageClass defines the "class" of storage (e.g., "fast SSD storage," "NFS shares," "object storage"). It abstracts the underlying storage provider and dynamically provisions PVs when a PVC requests storage of that class. This allows administrators to define different tiers of storage with varying performance and cost characteristics.
*   **AMQ Broker Operator and Persistence**: When deploying AMQ Broker using the AMQ Broker Operator on OpenShift, you configure persistence directly within the `ActiveMQArtemis` Custom Resource (CR). The operator is responsible for orchestrating the creation of the necessary PVCs and ensuring that the broker pods are configured to mount these PVCs to their data directories. This ensures that the broker's journal files and message data are stored persistently on the requested storage.
*   **Access Modes for AMQ Broker**: For a single-node AMQ Broker instance, the `ReadWriteOnce` access mode is typically sufficient, meaning the volume can be mounted as read-write by a single node. In scenarios involving shared storage for high-availability deployments (e.g., shared-nothing architecture with replicated data or shared-store high availability where multiple brokers share the same persistent store), `ReadWriteMany` might be considered, though careful planning is required as AMQ Broker itself manages its persistence and concurrency with the underlying storage. For standard deployments, `ReadWriteOnce` is common.

[[managing-broker-storage-lab]]
== Hands-on Lab: Managing Storage for AMQ Broker

In this lab, you will deploy an AMQ Broker instance on OpenShift with persistent storage enabled. You will create a Persistent Volume Claim (PVC) and configure the AMQ Broker Custom Resource to utilize this PVC for its data and message logs.

=== Prerequisites

*   An OpenShift cluster with `oc` CLI configured.
*   The AMQ Broker Operator installed in your cluster (usually in the `amq-broker-operator` namespace or a designated operator namespace).
*   A project (namespace) where you have deployment permissions.
*   An available `StorageClass` in your OpenShift cluster (e.g., `ocs-storagecluster-cephfs`, `gp2`, `standard`, or a default one). You can check available StorageClasses using `oc get sc`.

=== Lab Steps

.  **Log in to OpenShift**
    If not already logged in, use the `oc login` command.
    ```bash
    oc login --token=<your_token> --server=<your_openshift_api_server>
    ```

.  **Create a New Project (if needed)**
    For this lab, let's create a new project.
    ```bash
    oc new-project amq-broker-storage-lab
    ```
    Switch to your new project:
    ```bash
    oc project amq-broker-storage-lab
    ```

.  **Verify Available StorageClass**
    Before creating a PVC, ensure you know which StorageClass to use.
    ```bash
    oc get sc
    ```
    Choose one suitable for block storage (e.g., `gp2`, `standard`, or a specific CSI driver one). We will assume `standard` for this lab; replace it if your cluster uses a different default.

.  **Create a Persistent Volume Claim (PVC)**
    Define a YAML file named `amq-pvc.yaml` to request a 1Gi persistent volume.

    ```yaml
    # amq-pvc.yaml
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: amq-broker-data
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
      storageClassName: standard # Replace with your cluster's StorageClass if different
    ```

    Apply the PVC to your OpenShift cluster:
    ```bash
    oc apply -f amq-pvc.yaml
    ```

    Verify the PVC has been created and bound to a PV:
    ```bash
    oc get pvc amq-broker-data
    ```
    Wait until the `STATUS` changes to `Bound`. This indicates that Kubernetes has successfully provisioned a PV for your claim.

.  **Deploy AMQ Broker with Persistent Storage**
    Now, create an `ActiveMQArtemis` Custom Resource that references the PVC you just created.
    Define a YAML file named `amq-broker-persistence.yaml`:

    ```yaml
    # amq-broker-persistence.yaml
    apiVersion: broker.amq.io/v1beta1
    kind: ActiveMQArtemis
    metadata:
      name: my-amq-broker-persistent
    spec:
      deploymentPlan:
        size: 1
        image: registry.redhat.io/amq7/amq-broker-rhel8:7.12
        persistence:
          persistentVolumeClaim:
            claimName: amq-broker-data # Reference the PVC created earlier
        extraMounts:
          - name: amq-broker-data
            mountPath: /opt/amq-broker/data # Default data path for AMQ Broker
    ```
    *   `spec.deploymentPlan.persistence.persistentVolumeClaim.claimName`: This is the crucial part that links your broker instance to the `amq-broker-data` PVC.
    *   `spec.deploymentPlan.extraMounts`: While the operator often handles the default data directory mounting, explicitly defining an `extraMount` ensures the correct path is used and reinforces understanding. The AMQ Broker's default data directory is typically `/opt/amq-broker/data`.

    Apply this configuration:
    ```bash
    oc apply -f amq-broker-persistence.yaml
    ```

.  **Verify Broker Deployment and Storage Usage**
    Monitor the deployment of your AMQ Broker:
    ```bash
    oc get activemqartemis
    oc get pod -l app=my-amq-broker-persistent
    ```
    Wait until the pod is `Running`.

    Inspect the broker pod to confirm the volume is mounted:
    ```bash
    oc describe pod $(oc get pod -l app=my-amq-broker-persistent -o jsonpath='{.items[0].metadata.name}') | grep -i "amq-broker-data"
    ```
    You should see output similar to this, confirming the volume mount:
    ```
    # Example output (details may vary)
    Volume:            amq-broker-data
    Type:              PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
    ClaimName:         amq-broker-data
    Mounts:
      /opt/amq-broker/data from amq-broker-data (rw)
    ```

    You can also exec into the pod and list the contents of the data directory:
    ```bash
    oc exec -it $(oc get pod -l app=my-amq-broker-persistent -o jsonpath='{.items[0].metadata.name}') -- ls -l /opt/amq-broker/data
    ```
    You should see directories like `journal`, `paging`, `large-messages`, etc., indicating that the broker is using the persistent storage.

.  **Clean Up (Optional)**
    To remove the deployed broker and the PVC:
    ```bash
    oc delete activemqartemis my-amq-broker-persistent
    oc delete pvc amq-broker-data
    ```
    Make sure the broker pod terminates before deleting the PVC, otherwise the PVC might get stuck in `Terminating` state.

This lab demonstrates how to effectively provision and manage persistent storage for your Red Hat AMQ Broker instances on OpenShift, ensuring the durability of your messaging data.