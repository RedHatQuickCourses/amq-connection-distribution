#  Integrating JMS/AMQP clients with Spring Boot

= Integrating JMS/AMQP clients with Spring Boot

Integrating messaging clients with Spring Boot simplifies the development of robust, enterprise-grade messaging applications. Spring Boot leverages its auto-configuration capabilities to reduce boilerplate code and streamline the setup for both Java Message Service (JMS) and Advanced Message Queuing Protocol (AMQP) clients, making it an excellent choice for interacting with ActiveMQ Artemis.

== Technical Explanation

Spring Boot provides dedicated "starters" that bundle the necessary dependencies and auto-configure common components for messaging integration. When working with ActiveMQ Artemis, which supports both JMS and AMQP 1.0, Spring Boot offers flexible options for connectivity.

=== Dependencies for ActiveMQ Artemis Integration

To integrate JMS or AMQP clients with Spring Boot for ActiveMQ Artemis, you need to include the appropriate starter dependencies in your `pom.xml` (Maven) or `build.gradle` (Gradle) file.

==== JMS Integration

For JMS integration, Spring Boot typically uses the `spring-boot-starter-activemq` which works seamlessly with ActiveMQ Artemis as it implements the JMS specification.

[source,xml]
.pom.xml for JMS
----
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-activemq</artifactId>
    </dependency>
    <!-- Optional: If you need a specific version of Artemis client or special features -->
    <!-- <dependency>
        <groupId>org.apache.activemq</groupId>
        <artifactId>artemis-jms-client-all</artifactId>
        <version>${artemis.version}</version>
    </dependency> -->
</dependencies>
----

When `spring-boot-starter-activemq` is present, Spring Boot auto-configures a `CachingConnectionFactory` and a `JmsTemplate`. It attempts to connect to a broker at `tcp://localhost:61616` by default.

==== AMQP Integration

For AMQP 1.0 integration (which ActiveMQ Artemis supports natively), the `spring-boot-starter-amqp` is used. While this starter is often associated with RabbitMQ (AMQP 0.9.1), it can be configured to work with ActiveMQ Artemis's AMQP 1.0 support by explicitly providing the connection factory.

[source,xml]
.pom.xml for AMQP
----
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-amqp</artifactId>
    </dependency>
    <!-- Add Artemis AMQP 1.0 client library if not implicitly handled by the starter or if specific features are needed -->
    <dependency>
        <groupId>org.apache.qpid</groupId>
        <artifactId>qpid-jms-client</artifactId>
        <version>${qpid-jms.version}</version>
    </dependency>
</dependencies>
----

With `spring-boot-starter-amqp`, Spring Boot auto-configures a `RabbitTemplate` and enables `@RabbitListener` annotations. When using Artemis, you'll need to configure a `ConnectionFactory` that points to Artemis rather than a RabbitMQ instance.

=== Configuring ActiveMQ Artemis Connectivity

Spring Boot applications use `application.properties` or `application.yml` files for configuration. Here's how to configure connectivity for Active respective protocols.

==== JMS Configuration for ActiveMQ Artemis

Spring Boot's JMS auto-configuration can be easily directed to an ActiveMQ Artemis broker using standard properties.

[source,properties]
.src/main/resources/application.properties for JMS
----
# JMS Broker URL for ActiveMQ Artemis
spring.activemq.broker-url=tcp://localhost:61616
spring.activemq.user=admin
spring.activemq.password=password
# Optional: Enable JTA for distributed transactions
# spring.jms.jta.enabled=true
----

When these properties are set, Spring Boot will automatically create and configure a `ConnectionFactory` that uses the specified broker URL and credentials. This `ConnectionFactory` is then used by the auto-configured `JmsTemplate` and `JmsListenerContainerFactory`.

==== AMQP Configuration for ActiveMQ Artemis

For AMQP 1.0 with ActiveMQ Artemis, you need to provide a custom `ConnectionFactory` bean that uses the Qpid JMS client (which supports AMQP 1.0) and points it to your Artemis broker.

[source,java]
.AmqpConfig.java for AMQP
----
package com.example.artemisclient;

import org.apache.qpid.jms.JmsConnectionFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.jms.connection.CachingConnectionFactory;
import org.springframework.jms.core.JmsTemplate;

import jakarta.jms.ConnectionFactory;

@Configuration
public class AmqpConfig {

    @Value("${artemis.amqp.broker-url}")
    private String brokerUrl;

    @Value("${artemis.amqp.user}")
    private String user;

    @Value("${artemis.amqp.password}")
    private String password;

    @Bean
    public ConnectionFactory amqpConnectionFactory() {
        JmsConnectionFactory factory = new JmsConnectionFactory(user, password, brokerUrl);
        // Additional configuration for Qpid JMS / AMQP 1.0
        // e.g., factory.setClientID("my-client-id");
        // factory.setReceiveLocalOnly(true); // Example property

        // Wrap with CachingConnectionFactory for performance in Spring
        return new CachingConnectionFactory(factory);
    }

    // You can then use this ConnectionFactory with a JmsTemplate if you prefer the JMS API,
    // or configure a MessageListenerContainer for AMQP 1.0 listeners.
    // Spring Boot's 'spring-boot-starter-amqp' is generally for RabbitMQ (AMQP 0.9.1).
    // For Artemis AMQP 1.0, you often still use the JMS API (with Qpid JMS client) but over AMQP protocol.
    // Alternatively, you can directly integrate with a low-level AMQP 1.0 client if needed.

    // Example of using JmsTemplate with the AMQP 1.0 connection factory
    @Bean
    public JmsTemplate amqpJmsTemplate(ConnectionFactory amqpConnectionFactory) {
        JmsTemplate jmsTemplate = new JmsTemplate(amqpConnectionFactory);
        // Optional: configure other JmsTemplate properties
        // jmsTemplate.setPubSubDomain(false); // For queues
        return jmsTemplate;
    }
}
----

And the corresponding `application.properties`:

[source,properties]
.src/main/resources/application.properties for AMQP with Qpid JMS
----
# AMQP Broker URL for ActiveMQ Artemis (using Qpid JMS client)
artemis.amqp.broker-url=amqp://localhost:5672
artemis.amqp.user=admin
artemis.amqp.password=password
----

In this AMQP example, we are using the `qpid-jms-client` which is a JMS client that communicates over the AMQP 1.0 protocol. Therefore, the Spring `JmsTemplate` and `@JmsListener` annotations can still be utilized, but the underlying communication will be via AMQP 1.0. If a more direct AMQP 1.0 client interaction (without the JMS abstraction) is required, you would integrate a specific AMQP 1.0 client library and manage connections and messaging directly.

=== Customizing Connection Factories

While Spring Boot auto-configures much of the messaging setup, you might need to customize the `ConnectionFactory` for specific requirements, such as enabling client IDs, setting connection timeouts, or configuring SSL/TLS.

For JMS, you can define your own `ConnectionFactory` bean, and Spring Boot will use it instead of its auto-configured one.

[source,java]
.CustomJmsConnectionFactoryConfig.java
----
package com.example.artemisclient;

import org.apache.activemq.artemis.jms.client.ActiveMQJMSConnectionFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.jms.connection.CachingConnectionFactory;

import jakarta.jms.ConnectionFactory;

@Configuration
public class CustomJmsConnectionFactoryConfig {

    @Bean
    public ConnectionFactory jmsConnectionFactory() {
        // Create an ActiveMQ Artemis specific connection factory
        ActiveMQJMSConnectionFactory factory = new ActiveMQJMSConnectionFactory("tcp://localhost:61616");
        factory.setUser("admin");
        factory.setPassword("password");
        factory.setClientID("my-spring-boot-app"); // Set a custom client ID

        // Wrap it in a CachingConnectionFactory for performance and resource management
        CachingConnectionFactory cachingConnectionFactory = new CachingConnectionFactory(factory);
        cachingConnectionFactory.setSessionCacheSize(10); // Cache up to 10 sessions

        return cachingConnectionFactory;
    }
}
----

By providing your own `ConnectionFactory` bean, you gain full control over its configuration, allowing you to fine-tune the client-side behavior to match your application's needs and the ActiveMQ Artemis broker's setup.

This integration forms the foundation upon which messaging producers and consumers will be built, enabling Spring Boot applications to reliably send and receive messages from ActiveMQ Artemis.