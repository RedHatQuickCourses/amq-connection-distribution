#  Configuring authorization and access control lists (ACLs)

= Configuring Authorization and Access Control Lists (ACLs)
:context: security-configuration

This topic delves into configuring authorization and access control lists (ACLs) for Red Hat AMQ Broker, focusing on how to manage user permissions for messaging resources such as addresses and queues. Understanding and implementing robust authorization is crucial for securing your messaging infrastructure and ensuring that only authorized users or applications can interact with specific resources.

== Understanding Authorization and ACLs

Authorization is the process of determining what an *authenticated* user or application is permitted to do. While authentication verifies *who* a user is, authorization determines *what* that user can access or perform. In Red Hat AMQ Broker, this granular control is achieved through Access Control Lists (ACLs).

=== The Role of ACLs in AMQ Broker

AMQ Broker uses a flexible security model where permissions are defined for various operations on messaging resources, such as sending messages to an address, consuming messages from a queue, or managing broker-level settings. These permissions are typically associated with *roles*, and authenticated users are assigned one or more roles.

The core of AMQ Broker's authorization mechanism lies within the `<security-settings>` block of its configuration. This block contains `<match>` elements that define authorization rules for specific addresses or address sets.

Here are the key aspects of AMQ Broker ACLs:

*   **Permissions**: Permissions grant the ability to perform specific actions. Common permissions include:
    *   `send`: Allows sending messages to an address.
    *   `consume`: Allows consuming messages from a queue on an address.
    *   `create-address`: Allows creating a new address.
    *   `create-durable-queue`: Allows creating durable queues on an address.
    *   `delete-durable-queue`: Allows deleting durable queues.
    *   `create-non-durable-queue`: Allows creating non-durable queues on an address.
    *   `delete-non-durable-queue`: Allows deleting non-durable queues.
    *   `manage`: Allows performing management operations on an address or the broker itself (e.g., pausing queues, viewing metrics).
*   **Roles**: Roles are logical groupings of permissions. Instead of assigning permissions directly to users, you assign permissions to roles, and then assign roles to users. This simplifies management. For example, you might have `producer`, `consumer`, and `admin` roles.
*   **Match Rules**: The `<match>` elements in `<security-settings>` define which addresses or address patterns these rules apply to. They use a URI-like syntax and support wildcards:
    *   `#`: Matches zero or more words (e.g., `queue.#` matches `queue.A`, `queue.B`, `queue.A.B`).
    *   `*`: Matches a single word (e.g., `queue.*` matches `queue.A`, `queue.B` but not `queue.A.B`).
*   **Order of Precedence**: When multiple match rules apply to an address, AMQ Broker prioritizes the most specific match. For example, a rule for `my.specific.queue` will take precedence over a rule for `my.#`. It's generally good practice to define more specific rules first.

=== How ACLs Translate to OpenShift Custom Resources

When deploying AMQ Broker on OpenShift using the AMQ Broker Operator, the `broker.xml` configuration is typically generated from the `ActiveMQArtemis` Custom Resource (CR). This means you define your security settings, including ACLs, directly within the `ActiveMQArtemis` CR's `spec.brokerProperties` or `spec.securitySettings` fields. The Operator then translates these into the appropriate XML configuration inside the broker pod.

An `ActiveMQArtemis` CR might include a `securitySettings` section like this:

[source,yaml]
----
apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-broker
spec:
  # ... other broker configurations ...
  securitySettings:
    - match: "my.queue.prod"
      permission:
        - roles: [ "producer" ]
          operation: "send"
        - roles: [ "consumer" ]
          operation: "consume"
    - match: "my.queue.dev"
      permission:
        - roles: [ "developer" ]
          operation: "send"
        - roles: [ "developer" ]
          operation: "consume"
    - match: "#" # Default rule for all other addresses
      permission:
        - roles: [ "admin" ]
          operation: "manage"
        - roles: [ "trusted-user" ]
          operation: "send"
        - roles: [ "trusted-user" ]
          operation: "consume"
----

This YAML snippet demonstrates how roles are mapped to operations for different address patterns within the `ActiveMQArtemis` CR.

== Hands-on Lab: Configuring Authorization with ACLs

This lab will guide you through configuring authorization rules for your AMQ Broker instance on OpenShift using its Custom Resource. We will define specific permissions for different user roles on various addresses.

=== Lab Objective

*   Configure authorization rules to restrict `send` and `consume` operations based on user roles.
*   Verify that users with appropriate roles can perform permitted actions and are blocked from unauthorized actions.

=== Prerequisites

*   An OpenShift cluster with `oc` CLI configured.
*   An AMQ Broker instance deployed using the AMQ Broker Operator (e.g., `my-broker` in the `amq-broker-project` namespace) from a previous lab.
*   Authentication configured for the broker (e.g., JAAS with `users.properties` or `login.config`). For this lab, we'll assume you have a `users.properties` file configured with the following:
    *   `user1=user1password,producer,consumer`
    *   `user2=user2password,producer`
    *   `user3=user3password,consumer`
    *   `admin=adminpassword,admin`
    *   Refer to the "Implementing user authentication mechanisms (e.g., JAAS, LDAP)" topic if you need to set this up.

=== Scenario

We will configure authorization such that:

*   Users with the `producer` role can send messages to `app.data.inbound`.
*   Users with the `consumer` role can consume messages from `app.data.outbound`.
*   Users with the `producer` role *cannot* consume from `app.data.outbound`.
*   Users with the `consumer` role *cannot* send to `app.data.inbound`.
*   `admin` users have full `manage` access.
*   All other actions are denied by default.

=== Steps

==== Step 1: Inspect the Current Broker Configuration

First, let's examine the existing `ActiveMQArtemis` Custom Resource to understand its current state.

. OpenShift CLI
+
[source,bash,subs="+attributes"]
----
oc get activemqartemis my-broker -n amq-broker-project -o yaml > my-broker-original-cr.yaml
----

Review the `my-broker-original-cr.yaml` file. Look for any existing `securitySettings` or `brokerProperties` that might conflict with our new rules. By default, if no `securitySettings` are defined, AMQ Broker might permit certain actions.

==== Step 2: Define New Roles and Update Authentication

As mentioned in the prerequisites, ensure your authentication mechanism (e.g., `users.properties` for JAAS) defines the roles `producer`, `consumer`, and `admin` and assigns them to the appropriate users.

If you are using a `ConfigMap` for `users.properties`, ensure it's updated as follows and mounted into your broker pod.

. `users.properties` content
+
[source,properties]
----
user1=user1password,producer,consumer
user2=user2password,producer
user3=user3password,consumer
admin=adminpassword,admin
----

. If you need to update the `ConfigMap` and restart the broker (if not already done):
+
[source,bash,subs="+attributes"]
----
oc create configmap my-broker-users-properties --from-file=users.properties -n amq-broker-project --dry-run=client -o yaml | oc apply -f -
# If the ConfigMap already exists, use 'oc replace' or 'oc edit' instead of 'oc create'
# oc replace --force -f <(oc create configmap my-broker-users-properties --from-file=users.properties -n amq-broker-project --dry-run=client -o yaml)
----
+
Make sure the `ActiveMQArtemis` CR references this `ConfigMap` for JAAS configuration. This would typically be under `spec.deploymentPlan.extraMounts` or similar, depending on how you've set up your JAAS.

==== Step 3: Modify the AMQ Broker Custom Resource for ACLs

Now, we will add the `securitySettings` to your `my-broker` `ActiveMQArtemis` CR.

. Edit the `ActiveMQArtemis` CR:
+
[source,bash,subs="+attributes"]
----
oc edit activemqartemis my-broker -n amq-broker-project
----

. Add or update the `spec.securitySettings` section with the following rules. Ensure proper YAML indentation.

+
[source,yaml]
----
apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: my-broker
  # ...
spec:
  # ... existing spec ...
  securitySettings:
    - match: "app.data.inbound"
      permission:
        - roles: [ "producer", "admin" ]
          operation: "send"
        - roles: [ "admin" ]
          operation: "consume" # Admin can do anything
    - match: "app.data.outbound"
      permission:
        - roles: [ "consumer", "admin" ]
          operation: "consume"
        - roles: [ "admin" ]
          operation: "send" # Admin can do anything
    - match: "#" # Catch-all for any other address
      permission:
        - roles: [ "admin" ]
          operation: "manage"
----

*   The first `match` rule `app.data.inbound` allows `producer` and `admin` roles to `send` messages. The `admin` role is also explicitly given `consume` here, demonstrating granular control.
*   The second `match` rule `app.data.outbound` allows `consumer` and `admin` roles to `consume` messages. The `admin` role is also explicitly given `send`.
*   The final `match` rule `#` is a catch-all. It ensures that only `admin` users have `manage` permissions on any address not explicitly covered, and implicitly denies all other operations for non-admin users on unspecified addresses.

==== Step 4: Apply the Updated Custom Resource

When you save and exit the `oc edit` command, the changes will be applied immediately. The AMQ Broker Operator will detect the update to the `ActiveMQArtemis` CR and reconfigure your broker pod. This might trigger a rolling restart of the broker pod to apply the new security settings.

Monitor the rollout:

. OpenShift CLI
+
[source,bash,subs="+attributes"]
----
oc get pod -n amq-broker-project -w
----

Wait until the broker pod is `Running` and `Ready` again.

==== Step 5: Verify Authorization Rules

Now, let's test our authorization configuration using a simple messaging client. You can use the `qpid-jms-client` or any other AMQP 1.0 compatible client. For simplicity, we'll use example commands that simulate client interactions.

You will need an AMQP 1.0 client library or a tool that can interact with the broker. If you don't have one readily available, you can build a simple Java client or use a tool like `cli-qpid-jms` if you have it installed.

First, identify the OpenShift route for your AMQP endpoint.

. OpenShift CLI
+
[source,bash,subs="+attributes"]
----
oc get route -n amq-broker-project
# Look for a route related to the AMQP protocol, e.g., 'my-broker-amqp'
----
+
Let's assume your AMQP route is `amqp://my-broker-amqp-amq-broker-project.apps.your-cluster-domain.com`.

For testing, we'll outline the expected outcomes. If you have a client, adapt these tests.

. **Test Case 1: `user2` (producer role) sending to `app.data.inbound`**
+
*Expected*: Success. `user2` has the `producer` role, which is authorized to `send` to `app.data.inbound`.
+
[source,bash]
----
# Example client command (conceptual)
amqp-send --broker-url='amqp://my-broker-amqp-amq-broker-project.apps.your-cluster-domain.com' \
          --username='user2' --password='user2password' \
          --address='app.data.inbound' --message-body='Hello from producer'
----

. **Test Case 2: `user2` (producer role) consuming from `app.data.outbound`**
+
*Expected*: Failure (Unauthorized). `user2` has `producer` role but not `consumer` role for `app.data.outbound`.
+
[source,bash]
----
# Example client command (conceptual)
amqp-receive --broker-url='amqp://my-broker-amqp-amq-broker-project.apps.your-cluster-domain.com' \
             --username='user2' --password='user2password' \
             --address='app.data.outbound'
----
+
You should see an authorization error message from the broker.

. **Test Case 3: `user3` (consumer role) consuming from `app.data.outbound`**
+
*Expected*: Success. `user3` has the `consumer` role, which is authorized to `consume` from `app.data.outbound`.
+
[source,bash]
----
# Example client command (conceptual)
amqp-receive --broker-url='amqp://my-broker-amqp-amq-broker-project.apps.your-cluster-domain.com' \
             --username='user3' --password='user3password' \
             --address='app.data.outbound'
----

. **Test Case 4: `user3` (consumer role) sending to `app.data.inbound`**
+
*Expected*: Failure (Unauthorized). `user3` has `consumer` role but not `producer` role for `app.data.inbound`.
+
[source,bash]
----
# Example client command (conceptual)
amqp-send --broker-url='amqp://my-broker-amqp-amq-broker-project.apps.your-cluster-domain.com' \
          --username='user3' --password='user3password' \
          --address='app.data.inbound' --message-body='Hello from consumer'
----
+
You should again see an authorization error message.

. **Test Case 5: `user1` (producer, consumer roles) sending to `app.data.inbound` and consuming from `app.data.outbound`**
+
*Expected*: Success for both. `user1` has both `producer` and `consumer` roles, so they should be authorized for both operations on the respective addresses.
+
[source,bash]
----
# Send from user1
amqp-send --broker-url='amqp://my-broker-amqp-amq-broker-project.apps.your-cluster-domain.com' \
          --username='user1' --password='user1password' \
          --address='app.data.inbound' --message-body='Hello from user1 producer'

# Consume from user1 (after sending a message to app.data.outbound with another authorized user if needed)
amqp-receive --broker-url='amqp://my-broker-amqp-amq-broker-project.apps.your-cluster-domain.com' \
             --username='user1' --password='user1password' \
             --address='app.data.outbound'
----

. **Test Case 6: `admin` user performing any operation**
+
*Expected*: Success. The `admin` role has broad `manage` permissions and explicit `send`/`consume` on our test addresses.
+
[source,bash]
----
# Send from admin
amqp-send --broker-url='amqp://my-broker-amqp-amq-broker-project.apps.your-cluster-domain.com' \
          --username='admin' --password='adminpassword' \
          --address='app.data.inbound' --message-body='Hello from admin'

# Consume from admin
amqp-receive --broker-url='amqp://my-broker-amqp-amq-broker-project.apps.your-cluster-domain.com' \
             --username='admin' --password='adminpassword' \
             --address='app.data.outbound'
----

If all tests behave as expected, your authorization configuration is working correctly.

==== Step 6: Clean Up (Optional)

To revert the authorization changes, you can edit the `ActiveMQArtemis` CR again and remove the `securitySettings` block, or revert to your `my-broker-original-cr.yaml` file.

. OpenShift CLI
+
[source,bash,subs="+attributes"]
----
oc apply -f my-broker-original-cr.yaml -n amq-broker-project
----

This lab demonstrated how to implement granular access control for your AMQ Broker instances on OpenShift, ensuring that your messaging resources are secure and accessible only by authorized entities.